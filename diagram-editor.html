<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid + BPMN 2.0 Editor | Simon Vegelahn</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bpmn-js@17.2.0/dist/bpmn-viewer.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600;700&display=swap');

        :root {
            --color-bg-hero: #0a0a0a;
            --color-bg-secondary: #111113;
            --color-bg-card: #161618;
            --color-bg-input: #1a1a1d;
            --color-text: #fafafa;
            --color-text-secondary: #b0b0b0;
            --color-text-muted: #606060;
            --color-accent: #3b82f6;
            --color-accent-hover: #60a5fa;
            --color-border: #262626;
            --color-border-subtle: #1f1f1f;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --shadow-card: 0 4px 24px rgba(0,0,0,0.4);
        }

        [data-theme="light"] {
            --color-bg-hero: #ffffff;
            --color-bg-secondary: #f5f5f7;
            --color-bg-card: #ffffff;
            --color-bg-input: #f8f8fa;
            --color-text: #0a0a0a;
            --color-text-secondary: #525252;
            --color-text-muted: #8a8a8a;
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-border: #e5e5e5;
            --color-border-subtle: #ebebeb;
            --shadow-card: 0 4px 24px rgba(0,0,0,0.08);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg-hero);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .header {
            height: 56px;
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-logo {
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--color-text);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-logo:hover { color: var(--color-accent); }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--color-accent), #8b5cf6);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 14px;
            height: 14px;
            color: white;
        }

        .header-divider {
            width: 1px;
            height: 24px;
            background: var(--color-border);
        }

        .header-title {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        .header-center {
            display: flex;
            gap: 0.25rem;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 0.25rem;
        }

        .mode-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .mode-btn:hover { color: var(--color-text); }

        .mode-btn.active {
            background: var(--color-accent);
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--color-border);
            background: var(--color-bg-card);
            color: var(--color-text-secondary);
            font-family: inherit;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .btn:hover {
            background: var(--color-bg-secondary);
            color: var(--color-text);
        }

        .btn svg { width: 16px; height: 16px; }

        .btn-primary {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-accent-hover);
            border-color: var(--color-accent-hover);
        }

        .theme-toggle {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle .icon-moon { display: none; }
        [data-theme="light"] .theme-toggle .icon-sun { display: none; }
        [data-theme="light"] .theme-toggle .icon-moon { display: block; }

        /* Main Layout */
        .main {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* Editor Panel */
        .editor-panel {
            width: 45%;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-border);
            background: var(--color-bg-card);
        }

        .editor-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .editor-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .editor-tab {
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            font-family: inherit;
        }

        .editor-tab:hover { color: var(--color-text-secondary); }

        .editor-tab.active {
            background: var(--color-bg-secondary);
            color: var(--color-text);
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-action {
            padding: 0.375rem;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editor-action:hover {
            background: var(--color-bg-secondary);
            color: var(--color-text);
        }

        .editor-action svg { width: 16px; height: 16px; }

        .editor-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .code-editor {
            flex: 1;
            padding: 1rem;
            background: var(--color-bg-input);
            border: none;
            resize: none;
            font-family: 'JetBrains Mono', 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.8125rem;
            line-height: 1.7;
            color: var(--color-text);
            outline: none;
            transition: box-shadow 0.15s ease;
        }

        .code-editor::placeholder { color: var(--color-text-muted); }

        /* Preview Panel */
        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--color-bg-hero);
            overflow: hidden;
        }

        .preview-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--color-bg-card);
        }

        .preview-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .preview-zoom {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .zoom-btn {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            background: var(--color-bg-secondary);
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .zoom-btn:hover {
            background: var(--color-bg-card);
            color: var(--color-text);
        }

        .zoom-level {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            min-width: 40px;
            text-align: center;
        }

        .preview-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .preview-content.align-start {
            align-items: flex-start;
            justify-content: flex-start;
        }

        #mermaid-output {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
            transform-origin: center center;
            transition: transform 0.2s ease;
        }

        #mermaid-output svg {
            max-width: 100%;
            height: auto;
        }

        #bpmn-container {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 8px;
        }

        .preview-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            color: #ef4444;
            font-size: 0.875rem;
            max-width: 500px;
        }

        .preview-error-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .preview-error-message {
            font-family: monospace;
            font-size: 0.8125rem;
            opacity: 0.9;
        }

        /* Dropdown menus */
        .examples-dropdown, .export-dropdown {
            position: relative;
        }

        .examples-menu, .export-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            box-shadow: var(--shadow-card);
            min-width: 220px;
            z-index: 100;
            display: none;
        }

        .export-menu { left: auto; right: 0; }

        .examples-menu.open, .export-menu.open { display: block; }

        .examples-menu-item, .export-menu-item {
            padding: 0.625rem 1rem;
            font-size: 0.8125rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid var(--color-border-subtle);
        }

        .examples-menu-item:last-child, .export-menu-item:last-child { border-bottom: none; }

        .examples-menu-item:hover, .export-menu-item:hover {
            background: var(--color-bg-secondary);
            color: var(--color-text);
        }

        .examples-menu-item-icon, .export-menu-item-icon {
            width: 18px;
            height: 18px;
            color: var(--color-text-muted);
        }

        .export-hint {
            margin-left: auto;
            font-size: 0.6875rem;
            color: var(--color-text-muted);
        }

        .export-menu-item.bpmn-only { display: none; }
        body.bpmn-mode .export-menu-item.bpmn-only { display: flex; }

        .file-input { display: none; }

        /* Resize handle */
        .resize-handle {
            width: 4px;
            background: var(--color-border);
            cursor: col-resize;
            transition: background 0.15s ease;
        }

        .resize-handle:hover { background: var(--color-accent); }

        /* BPMN Help Panel */
        .bpmn-help {
            border-top: 1px solid var(--color-border);
            background: var(--color-bg-secondary);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            max-height: 300px;
            overflow-y: auto;
        }

        .bpmn-help-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            background: var(--color-bg-secondary);
            z-index: 10;
        }

        .bpmn-help-title {
            font-weight: 600;
            color: var(--color-text-secondary);
            font-size: 0.8125rem;
        }

        .legend-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 0.125rem;
        }

        .legend-toggle-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.6875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .legend-toggle-btn:hover { color: var(--color-text-secondary); }

        .legend-toggle-btn.active {
            background: var(--color-accent);
            color: white;
        }

        .bpmn-help-content {
            padding: 0.75rem 1rem;
        }

        .legend-section {
            margin-bottom: 1rem;
        }

        .legend-section:last-child { margin-bottom: 0; }

        .legend-section-title {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.375rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.375rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin: 0.125rem 0;
        }

        .legend-item:hover {
            background: var(--color-bg-card);
        }

        .legend-item:active {
            transform: scale(0.98);
        }

        .legend-item code {
            background: var(--color-bg-input);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            color: var(--color-accent);
            white-space: nowrap;
            transition: all 0.15s ease;
        }

        .legend-item:hover code {
            background: var(--color-accent);
            color: white;
        }

        .legend-item span {
            color: var(--color-text-secondary);
            font-size: 0.6875rem;
        }

        .legend-item:hover span {
            color: var(--color-text);
        }

        .insert-hint {
            margin-left: auto;
            font-size: 0.5625rem;
            color: var(--color-text-muted);
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .legend-item:hover .insert-hint {
            opacity: 1;
        }

        .legend-complete { display: none; }
        .bpmn-help.complete .legend-complete { display: block; }
        .bpmn-help.complete .legend-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }

        /* Responsive */
        @media (max-width: 768px) {
            .main { flex-direction: column; }
            .editor-panel {
                width: 100%;
                height: 50%;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
            }
            .resize-handle { display: none; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="#" class="header-logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 3v18M3 12h18"/>
                    </svg>
                </div>
                BPMN Editor
            </a>
            <div class="header-divider"></div>
            <span class="header-title">Full BPMN 2.0 Support</span>
        </div>

        <div class="header-center">
            <button class="mode-btn active" id="mermaidModeBtn" onclick="setMode('mermaid')">Mermaid</button>
            <button class="mode-btn" id="bpmnModeBtn" onclick="setMode('bpmn')">BPMN</button>
        </div>

        <div class="header-right">
            <div class="examples-dropdown">
                <button class="btn" onclick="toggleExamples()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    Examples
                </button>
                <div class="examples-menu" id="examplesMenu">
                    <div class="examples-menu-item" onclick="loadExample('flowchart')">
                        <svg class="examples-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M12 8v8M8 12h8"/>
                        </svg>
                        Mermaid Flowchart
                    </div>
                    <div class="examples-menu-item" onclick="loadExample('bpmn-simple')">
                        <svg class="examples-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="5" cy="12" r="2"/>
                            <rect x="10" y="8" width="8" height="8" rx="1"/>
                            <circle cx="23" cy="12" r="2" fill="currentColor"/>
                        </svg>
                        BPMN: Simple Flow
                    </div>
                    <div class="examples-menu-item" onclick="loadExample('bpmn-gateways')">
                        <svg class="examples-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="6" width="12" height="12" rx="1" transform="rotate(45 12 12)"/>
                        </svg>
                        BPMN: All Gateways
                    </div>
                    <div class="examples-menu-item" onclick="loadExample('bpmn-events')">
                        <svg class="examples-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="9"/>
                            <circle cx="12" cy="12" r="6"/>
                        </svg>
                        BPMN: Event Types
                    </div>
                    <div class="examples-menu-item" onclick="loadExample('bpmn-tasks')">
                        <svg class="examples-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="6" width="18" height="12" rx="2"/>
                            <path d="M8 10h8M8 14h4"/>
                        </svg>
                        BPMN: Task Types
                    </div>
                    <div class="examples-menu-item" onclick="loadExample('bpmn-complete')">
                        <svg class="examples-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        BPMN: Complete Demo
                    </div>
                </div>
            </div>

            <label class="btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Load File
                <input type="file" class="file-input" id="fileInput" accept=".mermaid,.mmd,.bpmn,.xml,.txt" onchange="loadFile(event)">
            </label>

            <div class="export-dropdown">
                <button class="btn btn-primary" onclick="toggleExportMenu()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>
                <div class="export-menu" id="exportMenu">
                    <div class="export-menu-item" onclick="exportSVG()">
                        <svg class="export-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M7 12l3-3 2 2 5-5"/>
                        </svg>
                        Export as SVG
                        <span class="export-hint">Image</span>
                    </div>
                    <div class="export-menu-item bpmn-only" onclick="exportBPMN()">
                        <svg class="export-menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        Export as BPMN
                        <span class="export-hint">Signavio compatible</span>
                    </div>
                </div>
            </div>

            <button class="btn theme-toggle" id="themeToggle">
                <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
                <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>
    </header>

    <main class="main">
        <div class="editor-panel" id="editorPanel">
            <div class="editor-header">
                <div class="editor-tabs">
                    <button class="editor-tab active">Code</button>
                </div>
                <div class="editor-actions">
                    <button class="editor-action" onclick="copyCode()" title="Copy code">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                    <button class="editor-action" onclick="clearEditor()" title="Clear">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="editor-content">
                <textarea 
                    class="code-editor" 
                    id="codeEditor" 
                    placeholder="Enter your diagram code here..."
                    spellcheck="false"
                ></textarea>
            </div>
            
            <!-- BPMN Legend Panel -->
            <div class="bpmn-help" id="bpmnHelp" style="display: none;">
                <div class="bpmn-help-header">
                    <div class="bpmn-help-title">BPMN 2.0 Syntax Reference</div>
                    <div class="legend-toggle">
                        <button class="legend-toggle-btn active" onclick="setLegendMode('simple')">Simple</button>
                        <button class="legend-toggle-btn" onclick="setLegendMode('complete')">Complete</button>
                    </div>
                </div>
                <div class="bpmn-help-content">
                    <!-- EVENTS SECTION -->
                    <div class="legend-section">
                        <div class="legend-section-title">Events</div>
                        <div class="legend-grid">
                            <div class="legend-item" onclick="insertAtCursor('(start)')"><code>(start)</code> <span>Start Event</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('(end)')"><code>(end)</code> <span>End Event</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(start:message)')"><code>(start:message)</code> <span>Message Start</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(start:timer)')"><code>(start:timer)</code> <span>Timer Start</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(start:signal)')"><code>(start:signal)</code> <span>Signal Start</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(start:conditional)')"><code>(start:conditional)</code> <span>Conditional Start</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('(timer)')"><code>(timer)</code> <span>Timer Intermediate</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(catch:message)')"><code>(catch:message)</code> <span>Message Catch</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(catch:signal)')"><code>(catch:signal)</code> <span>Signal Catch</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(catch:conditional)')"><code>(catch:conditional)</code> <span>Conditional Catch</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(catch:link)')"><code>(catch:link)</code> <span>Link Catch</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(throw:message)')"><code>(throw:message)</code> <span>Message Throw</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(throw:signal)')"><code>(throw:signal)</code> <span>Signal Throw</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(throw:escalation)')"><code>(throw:escalation)</code> <span>Escalation Throw</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(throw:compensation)')"><code>(throw:compensation)</code> <span>Compensation Throw</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(throw:link)')"><code>(throw:link)</code> <span>Link Throw</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('(error)')"><code>(error)</code> <span>Error End</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(end:message)')"><code>(end:message)</code> <span>Message End</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(end:signal)')"><code>(end:signal)</code> <span>Signal End</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(end:escalation)')"><code>(end:escalation)</code> <span>Escalation End</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(end:compensation)')"><code>(end:compensation)</code> <span>Compensation End</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(end:cancel)')"><code>(end:cancel)</code> <span>Cancel End</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('(terminate)')"><code>(terminate)</code> <span>Terminate End</span><span class="insert-hint">click to insert</span></div>
                        </div>
                    </div>

                    <!-- ACTIVITIES SECTION -->
                    <div class="legend-section">
                        <div class="legend-section-title">Activities</div>
                        <div class="legend-grid">
                            <div class="legend-item" onclick="insertAtCursor('[Task Name]')"><code>[Task Name]</code> <span>Task (Generic)</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('[user: Task Name]')"><code>[user: Name]</code> <span>User Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('[service: Task Name]')"><code>[service: Name]</code> <span>Service Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[script: Task Name]')"><code>[script: Name]</code> <span>Script Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[rule: Task Name]')"><code>[rule: Name]</code> <span>Business Rule Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[send: Task Name]')"><code>[send: Name]</code> <span>Send Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[receive: Task Name]')"><code>[receive: Name]</code> <span>Receive Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[manual: Task Name]')"><code>[manual: Name]</code> <span>Manual Task</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[[Sub Process Name]]')"><code>[[Sub Process]]</code> <span>Sub-Process</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('[call: Activity Name]')"><code>[call: Name]</code> <span>Call Activity</span><span class="insert-hint">click to insert</span></div>
                        </div>
                    </div>

                    <!-- GATEWAYS SECTION -->
                    <div class="legend-section">
                        <div class="legend-section-title">Gateways</div>
                        <div class="legend-grid">
                            <div class="legend-item" onclick="insertAtCursor('<Decision?>')"><code>&lt;Decision?&gt;</code> <span>Exclusive (XOR)</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('<+Parallel>')"><code>&lt;+Split&gt;</code> <span>Parallel (AND)</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('<o Choice>')"><code>&lt;o Choice&gt;</code> <span>Inclusive (OR)</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('<* Complex>')"><code>&lt;* Complex&gt;</code> <span>Complex Gateway</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('<@ Event>')"><code>&lt;@ Event&gt;</code> <span>Event-Based</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor('<@+ Parallel Event>')"><code>&lt;@+ Parallel Event&gt;</code> <span>Parallel Event-Based</span><span class="insert-hint">click to insert</span></div>
                        </div>
                    </div>

                    <!-- DATA & ARTIFACTS SECTION -->
                    <div class="legend-section legend-complete">
                        <div class="legend-section-title">Data & Artifacts</div>
                        <div class="legend-grid">
                            <div class="legend-item" onclick="insertAtCursor('{data: Data Name}')"><code>{data: Name}</code> <span>Data Object</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('{store: Store Name}')"><code>{store: Name}</code> <span>Data Store</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor('// Comment text')"><code>// Comment text</code> <span>Text Annotation</span><span class="insert-hint">click to insert</span></div>
                        </div>
                    </div>

                    <!-- CONNECTIONS SECTION -->
                    <div class="legend-section">
                        <div class="legend-section-title">Connections</div>
                        <div class="legend-grid">
                            <div class="legend-item" onclick="insertAtCursor(' -> ')"><code>-></code> <span>Sequence Flow</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item" onclick="insertAtCursor(' |Yes| ')"><code>|Yes|</code> <span>Condition Label</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor(' -> ')"><code>~~></code> <span>Message Flow</span><span class="insert-hint">click to insert</span></div>
                            <div class="legend-item legend-complete" onclick="insertAtCursor(' -> ')"><code>--></code> <span>Association</span><span class="insert-hint">click to insert</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="resize-handle" id="resizeHandle"></div>

        <div class="preview-panel">
            <div class="preview-header">
                <span class="preview-title">Preview</span>
                <div class="preview-zoom">
                    <button class="zoom-btn" onclick="zoomOut()">−</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()" title="Reset">⟲</button>
                </div>
            </div>
            <div class="preview-content" id="previewContent">
                <div id="mermaid-output"></div>
                <div id="bpmn-container" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script>
        // State
        let currentMode = 'mermaid';
        let legendMode = 'simple';
        let zoomLevel = 1;
        let bpmnViewer = null;
        let debounceTimer = null;
        let lastBpmnXml = null;

        // Examples
        const examples = {
            flowchart: `flowchart TD
    A[Start] --> B{Is it working?}
    B -->|Yes| C[Great!]
    B -->|No| D[Debug]
    D --> E[Fix the code]
    E --> B
    C --> F[Deploy]
    F --> G[End]`,

            'bpmn-simple': `(start) -> [Receive Order] -> <In Stock?>
<In Stock?> -> |Yes| [Pack Items]
<In Stock?> -> |No| [Reorder Stock] -> [Wait for Delivery] -> [Pack Items]
[Pack Items] -> [Ship Order] -> (end)`,

            'bpmn-gateways': `(start) -> <Decision?>
<Decision?> -> |Path A| [Task A]
<Decision?> -> |Path B| [Task B]
[Task A] -> <+Merge>
[Task B] -> <+Merge>
<+Merge> -> <o Inclusive?>
<o Inclusive?> -> |Option 1| [Option Task 1]
<o Inclusive?> -> |Option 2| [Option Task 2]
[Option Task 1] -> <o Join>
[Option Task 2] -> <o Join>
<o Join> -> (end)`,

            'bpmn-events': `(start) -> [Initial Task]
[Initial Task] -> (timer) -> [After Wait]
[After Wait] -> <Check Result?>
<Check Result?> -> |Success| [user: Process Result] -> (end)
<Check Result?> -> |Failure| [Log Error] -> (error)`,

            'bpmn-tasks': `(start) -> [user: Review Request]
[user: Review Request] -> [service: Validate Data]
[service: Validate Data] -> [script: Transform Data]
[script: Transform Data] -> [rule: Apply Business Rules]
[rule: Apply Business Rules] -> [send: Send Notification]
[send: Send Notification] -> [receive: Wait for Response]
[receive: Wait for Response] -> [manual: Physical Inspection]
[manual: Physical Inspection] -> (end)`,

            'bpmn-complete': `// Complete BPMN 2.0 Demo
(start:message) -> [user: Receive Request]
[user: Receive Request] -> <+Parallel Split>
<+Parallel Split> -> [service: Validate] -> (timer) -> [Check Status]
<+Parallel Split> -> [script: Log Request]
[Check Status] -> <Approved?>
<Approved?> -> |Yes| [rule: Apply Policy]
<Approved?> -> |No| (throw:escalation) -> [Handle Escalation] -> (end:escalation)
[rule: Apply Policy] -> <o Options>
<o Options> -> |Full| [send: Full Notification]
<o Options> -> |Partial| [send: Partial Notification]
[send: Full Notification] -> <o Merge>
[send: Partial Notification] -> <o Merge>
<o Merge> -> <+Parallel Join>
[script: Log Request] -> <+Parallel Join>
<+Parallel Join> -> [receive: Wait Confirmation]
[receive: Wait Confirmation] -> [manual: Final Review]
[manual: Final Review] -> (terminate)`
        };

        // BPMN Element Type Mappings
        const BPMN_ELEMENTS = {
            // Start Events
            '(start)': { type: 'startEvent', subType: null },
            '(start:message)': { type: 'startEvent', subType: 'messageEventDefinition' },
            '(start:timer)': { type: 'startEvent', subType: 'timerEventDefinition' },
            '(start:signal)': { type: 'startEvent', subType: 'signalEventDefinition' },
            '(start:conditional)': { type: 'startEvent', subType: 'conditionalEventDefinition' },
            '(start:multiple)': { type: 'startEvent', subType: 'multipleEventDefinition' },
            
            // Intermediate Catch Events
            '(timer)': { type: 'intermediateCatchEvent', subType: 'timerEventDefinition' },
            '(catch:message)': { type: 'intermediateCatchEvent', subType: 'messageEventDefinition' },
            '(catch:timer)': { type: 'intermediateCatchEvent', subType: 'timerEventDefinition' },
            '(catch:signal)': { type: 'intermediateCatchEvent', subType: 'signalEventDefinition' },
            '(catch:conditional)': { type: 'intermediateCatchEvent', subType: 'conditionalEventDefinition' },
            '(catch:link)': { type: 'intermediateCatchEvent', subType: 'linkEventDefinition' },
            
            // Intermediate Throw Events
            '(throw:message)': { type: 'intermediateThrowEvent', subType: 'messageEventDefinition' },
            '(throw:signal)': { type: 'intermediateThrowEvent', subType: 'signalEventDefinition' },
            '(throw:escalation)': { type: 'intermediateThrowEvent', subType: 'escalationEventDefinition' },
            '(throw:compensation)': { type: 'intermediateThrowEvent', subType: 'compensateEventDefinition' },
            '(throw:link)': { type: 'intermediateThrowEvent', subType: 'linkEventDefinition' },
            
            // End Events
            '(end)': { type: 'endEvent', subType: null },
            '(error)': { type: 'endEvent', subType: 'errorEventDefinition' },
            '(end:message)': { type: 'endEvent', subType: 'messageEventDefinition' },
            '(end:signal)': { type: 'endEvent', subType: 'signalEventDefinition' },
            '(end:escalation)': { type: 'endEvent', subType: 'escalationEventDefinition' },
            '(end:compensation)': { type: 'endEvent', subType: 'compensateEventDefinition' },
            '(end:cancel)': { type: 'endEvent', subType: 'cancelEventDefinition' },
            '(terminate)': { type: 'endEvent', subType: 'terminateEventDefinition' },
        };

        // Gateway patterns
        const GATEWAY_PATTERNS = [
            { prefix: '<+', type: 'parallelGateway' },
            { prefix: '<o', type: 'inclusiveGateway' },
            { prefix: '<*', type: 'complexGateway' },
            { prefix: '<@+', type: 'eventBasedGateway', parallelMultiple: true },
            { prefix: '<@', type: 'eventBasedGateway' },
            { prefix: '<', type: 'exclusiveGateway' }, // Default - must be last
        ];

        // Task type patterns
        const TASK_PATTERNS = [
            { prefix: 'user:', type: 'userTask' },
            { prefix: 'service:', type: 'serviceTask' },
            { prefix: 'script:', type: 'scriptTask' },
            { prefix: 'rule:', type: 'businessRuleTask' },
            { prefix: 'send:', type: 'sendTask' },
            { prefix: 'receive:', type: 'receiveTask' },
            { prefix: 'manual:', type: 'manualTask' },
            { prefix: 'call:', type: 'callActivity' },
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initMermaid();
            initResizer();
            
            document.getElementById('codeEditor').value = examples.flowchart;
            renderDiagram();

            document.getElementById('codeEditor').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(renderDiagram, 300);
            });
        });

        // Theme
        function initTheme() {
            const toggle = document.getElementById('themeToggle');
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (saved === 'light' || (!saved && !prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'light');
            }

            toggle.addEventListener('click', () => {
                const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                const newTheme = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                if (currentMode === 'mermaid') {
                    initMermaid();
                    renderDiagram();
                }
            });
        }

        // Legend mode toggle
        function setLegendMode(mode) {
            legendMode = mode;
            const help = document.getElementById('bpmnHelp');
            const btns = document.querySelectorAll('.legend-toggle-btn');
            
            btns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'complete') {
                help.classList.add('complete');
            } else {
                help.classList.remove('complete');
            }
        }

        // Mermaid
        function initMermaid() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            mermaid.initialize({
                startOnLoad: false,
                theme: isDark ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: { useMaxWidth: true, htmlLabels: true },
                sequence: { useMaxWidth: true },
            });
        }

        // Set mode
        function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('mermaidModeBtn').classList.toggle('active', mode === 'mermaid');
            document.getElementById('bpmnModeBtn').classList.toggle('active', mode === 'bpmn');
            document.getElementById('bpmnHelp').style.display = mode === 'bpmn' ? 'block' : 'none';
            
            document.getElementById('mermaid-output').style.display = mode === 'mermaid' ? 'block' : 'none';
            document.getElementById('bpmn-container').style.display = mode === 'bpmn' ? 'block' : 'none';

            document.body.classList.toggle('bpmn-mode', mode === 'bpmn');

            const editor = document.getElementById('codeEditor');
            if (mode === 'mermaid' && (editor.value.includes('(start)') || editor.value.includes('(end)'))) {
                editor.value = examples.flowchart;
            } else if (mode === 'bpmn' && !editor.value.includes('(start)') && !editor.value.includes('(end)')) {
                editor.value = examples['bpmn-simple'];
            }

            renderDiagram();
        }

        // Render
        async function renderDiagram() {
            const code = document.getElementById('codeEditor').value.trim();
            if (!code) return;

            if (currentMode === 'mermaid') {
                await renderMermaid(code);
            } else {
                await renderBPMN(code);
            }
        }

        async function renderMermaid(code) {
            const output = document.getElementById('mermaid-output');
            
            try {
                const { svg } = await mermaid.render('mermaid-svg', code);
                output.innerHTML = svg;
                output.style.transform = `scale(${zoomLevel})`;
                document.getElementById('previewContent').classList.remove('align-start');
            } catch (error) {
                output.innerHTML = `
                    <div class="preview-error">
                        <div class="preview-error-title">Syntax Error</div>
                        <div class="preview-error-message">${error.message || 'Invalid diagram syntax'}</div>
                    </div>
                `;
            }
        }

        async function renderBPMN(code) {
            const container = document.getElementById('bpmn-container');
            document.getElementById('previewContent').classList.add('align-start');
            
            try {
                const xml = convertToBPMNXml(code);
                lastBpmnXml = xml;
                
                if (!bpmnViewer) {
                    bpmnViewer = new BpmnJS({ container: container });
                }
                
                await bpmnViewer.importXML(xml);
                bpmnViewer.get('canvas').zoom('fit-viewport');
            } catch (error) {
                lastBpmnXml = null;
                container.innerHTML = `
                    <div class="preview-error" style="margin: 2rem;">
                        <div class="preview-error-title">BPMN Error</div>
                        <div class="preview-error-message">${error.message || 'Invalid BPMN syntax'}</div>
                    </div>
                `;
            }
        }

        // Parse element from DSL part
        function parseElement(part) {
            let type = 'task';
            let subType = null;
            let name = part;
            let width = 100;
            let height = 80;
            let taskType = null;

            // Check for comments/annotations
            if (part.startsWith('//')) {
                return {
                    type: 'textAnnotation',
                    name: part.slice(2).trim(),
                    width: 120,
                    height: 50,
                    subType: null,
                    taskType: null
                };
            }

            // Check for data objects
            if (part.startsWith('{data:') && part.endsWith('}')) {
                return {
                    type: 'dataObjectReference',
                    name: part.slice(6, -1).trim(),
                    width: 36,
                    height: 50,
                    subType: null,
                    taskType: null
                };
            }

            // Check for data stores
            if (part.startsWith('{store:') && part.endsWith('}')) {
                return {
                    type: 'dataStoreReference',
                    name: part.slice(7, -1).trim(),
                    width: 50,
                    height: 50,
                    subType: null,
                    taskType: null
                };
            }

            // Check for known event patterns
            const lowerPart = part.toLowerCase();
            for (const [pattern, config] of Object.entries(BPMN_ELEMENTS)) {
                if (lowerPart === pattern.toLowerCase()) {
                    return {
                        type: config.type,
                        subType: config.subType,
                        name: '',
                        width: 36,
                        height: 36,
                        taskType: null
                    };
                }
            }

            // Check for gateways
            if (part.startsWith('<') && part.endsWith('>')) {
                const gatewayContent = part.slice(1, -1);
                
                for (const gw of GATEWAY_PATTERNS) {
                    const checkPrefix = gw.prefix.slice(1); // Remove leading <
                    if (gatewayContent.startsWith(checkPrefix)) {
                        return {
                            type: gw.type,
                            name: gatewayContent.slice(checkPrefix.length).trim(),
                            width: 50,
                            height: 50,
                            subType: gw.parallelMultiple ? 'parallelMultiple' : null,
                            taskType: null
                        };
                    }
                }
                
                // Default exclusive gateway
                return {
                    type: 'exclusiveGateway',
                    name: gatewayContent,
                    width: 50,
                    height: 50,
                    subType: null,
                    taskType: null
                };
            }

            // Check for sub-processes
            if (part.startsWith('[[') && part.endsWith(']]')) {
                return {
                    type: 'subProcess',
                    name: part.slice(2, -2).trim(),
                    width: 120,
                    height: 100,
                    subType: null,
                    taskType: null
                };
            }

            // Check for tasks with type prefix
            if (part.startsWith('[') && part.endsWith(']')) {
                let taskContent = part.slice(1, -1).trim();
                let detectedTaskType = 'task';
                
                for (const tp of TASK_PATTERNS) {
                    if (taskContent.toLowerCase().startsWith(tp.prefix.toLowerCase())) {
                        detectedTaskType = tp.type;
                        taskContent = taskContent.slice(tp.prefix.length).trim();
                        break;
                    }
                }
                
                return {
                    type: detectedTaskType,
                    name: taskContent,
                    width: 100,
                    height: 80,
                    subType: null,
                    taskType: detectedTaskType
                };
            }

            // Default task
            return {
                type: 'task',
                name: part,
                width: 100,
                height: 80,
                subType: null,
                taskType: null
            };
        }

        // Convert DSL to BPMN XML
        function convertToBPMNXml(code) {
            const lines = code.split('\n').filter(l => l.trim() && !l.trim().startsWith('//'));
            const elements = new Map();
            const flows = [];
            const annotations = [];
            let elementId = 0;

            // Parse all elements and flows
            lines.forEach(line => {
                // Handle annotations separately
                if (line.trim().startsWith('//')) {
                    annotations.push({
                        id: `Annotation_${++elementId}`,
                        text: line.trim().slice(2).trim()
                    });
                    return;
                }

                // Normalize all connector types to -> for parsing
                // Supports: -> (sequence), ~~> (message), --> (association)
                let normalizedLine = line
                    .replace(/~~>/g, '->')
                    .replace(/-->/g, '->');

                const parts = normalizedLine.split('->').map(p => p.trim()).filter(p => p);
                
                for (let i = 0; i < parts.length; i++) {
                    let part = parts[i];
                    let condition = null;
                    
                    // Check for condition
                    const condMatch = part.match(/^\|([^|]+)\|\s*(.+)$/);
                    if (condMatch) {
                        condition = condMatch[1];
                        part = condMatch[2];
                    }
                    
                    // Create element if not exists
                    if (!elements.has(part)) {
                        elementId++;
                        const parsed = parseElement(part);
                        
                        elements.set(part, { 
                            id: `Element_${elementId}`, 
                            type: parsed.type,
                            subType: parsed.subType,
                            taskType: parsed.taskType,
                            name: parsed.name,
                            key: part,
                            width: parsed.width,
                            height: parsed.height
                        });
                    }
                    
                    // Create flow from previous element
                    if (i > 0) {
                        let sourcePart = parts[i - 1];
                        const srcCondMatch = sourcePart.match(/^\|([^|]+)\|\s*(.+)$/);
                        if (srcCondMatch) {
                            sourcePart = srcCondMatch[2];
                        }
                        
                        const source = elements.get(sourcePart);
                        const target = elements.get(part);
                        
                        if (source && target) {
                            flows.push({
                                id: `Flow_${flows.length + 1}`,
                                sourceRef: source.id,
                                targetRef: target.id,
                                sourceKey: sourcePart,
                                targetKey: part,
                                name: condition || ''
                            });
                        }
                    }
                }
            });

            // Use dagre for layout
            const g = new dagre.graphlib.Graph();
            g.setGraph({
                rankdir: 'LR',
                nodesep: 60,
                ranksep: 80,
                marginx: 50,
                marginy: 50
            });
            g.setDefaultEdgeLabel(() => ({}));

            // Add nodes
            elements.forEach((el, key) => {
                g.setNode(key, { 
                    width: el.width, 
                    height: el.height,
                    element: el
                });
            });

            // Add edges
            flows.forEach(flow => {
                g.setEdge(flow.sourceKey, flow.targetKey);
            });

            // Calculate layout
            dagre.layout(g);

            // Extract positions
            const positions = new Map();
            g.nodes().forEach(key => {
                const node = g.node(key);
                if (node) {
                    positions.set(key, {
                        x: node.x - node.width / 2,
                        y: node.y - node.height / 2,
                        width: node.width,
                        height: node.height
                    });
                }
            });

            // Generate BPMN XML
            let processContent = '';
            let shapeContent = '';
            let edgeContent = '';

            elements.forEach((el, key) => {
                const pos = positions.get(key) || { x: 100, y: 100 };
                const eventDefinition = el.subType ? `<bpmn:${el.subType}/>` : '';
                
                // Process content based on type
                switch (el.type) {
                    case 'startEvent':
                        processContent += `<bpmn:startEvent id="${el.id}" name="${escapeXml(el.name)}">${eventDefinition}</bpmn:startEvent>\n`;
                        shapeContent += generateShape(el.id, pos, 36, 36);
                        break;
                        
                    case 'endEvent':
                        processContent += `<bpmn:endEvent id="${el.id}" name="${escapeXml(el.name)}">${eventDefinition}</bpmn:endEvent>\n`;
                        shapeContent += generateShape(el.id, pos, 36, 36);
                        break;
                        
                    case 'intermediateCatchEvent':
                        processContent += `<bpmn:intermediateCatchEvent id="${el.id}" name="${escapeXml(el.name)}">${eventDefinition}</bpmn:intermediateCatchEvent>\n`;
                        shapeContent += generateShape(el.id, pos, 36, 36);
                        break;
                        
                    case 'intermediateThrowEvent':
                        processContent += `<bpmn:intermediateThrowEvent id="${el.id}" name="${escapeXml(el.name)}">${eventDefinition}</bpmn:intermediateThrowEvent>\n`;
                        shapeContent += generateShape(el.id, pos, 36, 36);
                        break;
                        
                    case 'exclusiveGateway':
                        processContent += `<bpmn:exclusiveGateway id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateGatewayShape(el.id, pos, el.name);
                        break;
                        
                    case 'parallelGateway':
                        processContent += `<bpmn:parallelGateway id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateGatewayShape(el.id, pos, el.name);
                        break;
                        
                    case 'inclusiveGateway':
                        processContent += `<bpmn:inclusiveGateway id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateGatewayShape(el.id, pos, el.name);
                        break;
                        
                    case 'complexGateway':
                        processContent += `<bpmn:complexGateway id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateGatewayShape(el.id, pos, el.name);
                        break;
                        
                    case 'eventBasedGateway':
                        processContent += `<bpmn:eventBasedGateway id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateGatewayShape(el.id, pos, el.name);
                        break;
                        
                    case 'userTask':
                        processContent += `<bpmn:userTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'serviceTask':
                        processContent += `<bpmn:serviceTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'scriptTask':
                        processContent += `<bpmn:scriptTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'businessRuleTask':
                        processContent += `<bpmn:businessRuleTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'sendTask':
                        processContent += `<bpmn:sendTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'receiveTask':
                        processContent += `<bpmn:receiveTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'manualTask':
                        processContent += `<bpmn:manualTask id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'callActivity':
                        processContent += `<bpmn:callActivity id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                        break;
                        
                    case 'subProcess':
                        processContent += `<bpmn:subProcess id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 120, 100, true);
                        break;
                        
                    case 'dataObjectReference':
                        processContent += `<bpmn:dataObjectReference id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 36, 50);
                        break;
                        
                    case 'dataStoreReference':
                        processContent += `<bpmn:dataStoreReference id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 50, 50);
                        break;
                        
                    case 'textAnnotation':
                        processContent += `<bpmn:textAnnotation id="${el.id}"><bpmn:text>${escapeXml(el.name)}</bpmn:text></bpmn:textAnnotation>\n`;
                        shapeContent += generateShape(el.id, pos, 120, 50);
                        break;
                        
                    default:
                        processContent += `<bpmn:task id="${el.id}" name="${escapeXml(el.name)}"/>\n`;
                        shapeContent += generateShape(el.id, pos, 100, 80);
                }
            });

            // Generate edges
            flows.forEach(flow => {
                const sourceEl = elements.get(flow.sourceKey);
                const targetEl = elements.get(flow.targetKey);
                const sp = positions.get(flow.sourceKey);
                const tp = positions.get(flow.targetKey);
                
                if (!sp || !tp || !sourceEl || !targetEl) return;
                
                const edge = g.edge(flow.sourceKey, flow.targetKey);
                
                processContent += `<bpmn:sequenceFlow id="${flow.id}" name="${escapeXml(flow.name)}" sourceRef="${flow.sourceRef}" targetRef="${flow.targetRef}"/>\n`;
                
                let waypointsXml = '';
                if (edge && edge.points && edge.points.length > 0) {
                    edge.points.forEach(pt => {
                        waypointsXml += `<di:waypoint x="${Math.round(pt.x)}" y="${Math.round(pt.y)}"/>\n`;
                    });
                } else {
                    const sx = sp.x + sp.width;
                    const sy = sp.y + sp.height / 2;
                    const tx = tp.x;
                    const ty = tp.y + tp.height / 2;
                    waypointsXml = `<di:waypoint x="${sx}" y="${sy}"/>\n<di:waypoint x="${tx}" y="${ty}"/>\n`;
                }
                
                let labelXml = '';
                if (flow.name && edge && edge.points && edge.points.length >= 2) {
                    const midIdx = Math.floor(edge.points.length / 2);
                    const midPt = edge.points[midIdx];
                    labelXml = `<bpmndi:BPMNLabel><dc:Bounds x="${Math.round(midPt.x) - 15}" y="${Math.round(midPt.y) - 20}" width="40" height="14"/></bpmndi:BPMNLabel>`;
                }
                
                edgeContent += `<bpmndi:BPMNEdge id="${flow.id}_di" bpmnElement="${flow.id}">
                    ${waypointsXml}${labelXml}
                </bpmndi:BPMNEdge>\n`;
            });

            return `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
    <bpmn:process id="Process_1" isExecutable="false">
        ${processContent}
    </bpmn:process>
    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
            ${shapeContent}
            ${edgeContent}
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
        }

        function generateShape(id, pos, width, height, isExpanded = false) {
            const expanded = isExpanded ? ' isExpanded="false"' : '';
            return `<bpmndi:BPMNShape id="${id}_di" bpmnElement="${id}"${expanded}>
                <dc:Bounds x="${Math.round(pos.x)}" y="${Math.round(pos.y)}" width="${width}" height="${height}"/>
            </bpmndi:BPMNShape>\n`;
        }

        function generateGatewayShape(id, pos, name) {
            return `<bpmndi:BPMNShape id="${id}_di" bpmnElement="${id}" isMarkerVisible="true">
                <dc:Bounds x="${Math.round(pos.x)}" y="${Math.round(pos.y)}" width="50" height="50"/>
                <bpmndi:BPMNLabel><dc:Bounds x="${Math.round(pos.x) - 5}" y="${Math.round(pos.y) + 58}" width="60" height="14"/></bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>\n`;
        }

        function escapeXml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&apos;');
        }

        // Load example
        function loadExample(name) {
            closeExamples();
            
            if (name.startsWith('bpmn-')) {
                setMode('bpmn');
            } else {
                setMode('mermaid');
            }
            
            document.getElementById('codeEditor').value = examples[name];
            renderDiagram();
        }

        // Dropdown handlers
        function toggleExamples() {
            document.getElementById('examplesMenu').classList.toggle('open');
        }

        function closeExamples() {
            document.getElementById('examplesMenu').classList.remove('open');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.examples-dropdown')) closeExamples();
            if (!e.target.closest('.export-dropdown')) closeExportMenu();
        });

        // File handling
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                document.getElementById('codeEditor').value = content;
                
                if (file.name.endsWith('.bpmn') || file.name.endsWith('.xml') || content.includes('bpmn:')) {
                    setMode('bpmn');
                } else {
                    setMode('mermaid');
                }
                
                renderDiagram();
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Export
        function toggleExportMenu() {
            document.getElementById('exportMenu').classList.toggle('open');
            closeExamples();
        }

        function closeExportMenu() {
            document.getElementById('exportMenu').classList.remove('open');
        }

        async function exportSVG() {
            closeExportMenu();
            
            let svgContent;
            
            if (currentMode === 'mermaid') {
                const svg = document.querySelector('#mermaid-output svg');
                if (!svg) { alert('No diagram to export'); return; }
                svgContent = new XMLSerializer().serializeToString(svg);
            } else {
                if (!bpmnViewer) { alert('No diagram to export'); return; }
                try {
                    const result = await bpmnViewer.saveSVG();
                    svgContent = result.svg;
                } catch (err) {
                    console.error('SVG export failed:', err);
                    alert('Failed to export SVG');
                    return;
                }
            }

            downloadFile(svgContent, `diagram-${Date.now()}.svg`, 'image/svg+xml');
        }

        function exportBPMN() {
            closeExportMenu();
            
            if (currentMode !== 'bpmn') {
                alert('BPMN export only available in BPMN mode');
                return;
            }

            if (!lastBpmnXml) {
                alert('No diagram to export');
                return;
            }

            downloadFile(lastBpmnXml, `process-${Date.now()}.bpmn`, 'application/xml');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Editor actions
        function copyCode() {
            const editor = document.getElementById('codeEditor');
            navigator.clipboard.writeText(editor.value);
        }

        // Insert text at cursor position in editor
        function insertAtCursor(text) {
            const editor = document.getElementById('codeEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;
            
            // Insert the text at cursor position
            editor.value = value.substring(0, start) + text + value.substring(end);
            
            // Move cursor to end of inserted text
            const newCursorPos = start + text.length;
            editor.selectionStart = newCursorPos;
            editor.selectionEnd = newCursorPos;
            
            // Focus the editor
            editor.focus();
            
            // Trigger re-render with debounce
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(renderDiagram, 300);
            
            // Visual feedback - brief highlight
            showInsertFeedback();
        }

        // Show brief visual feedback when inserting
        function showInsertFeedback() {
            const editor = document.getElementById('codeEditor');
            editor.style.boxShadow = '0 0 0 2px var(--color-accent)';
            setTimeout(() => {
                editor.style.boxShadow = '';
            }, 200);
        }

        function clearEditor() {
            document.getElementById('codeEditor').value = '';
            document.getElementById('mermaid-output').innerHTML = '';
            if (bpmnViewer) bpmnViewer.clear();
        }

        // Zoom
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.1, 2);
            updateZoom();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
            updateZoom();
        }

        function resetZoom() {
            zoomLevel = 1;
            updateZoom();
        }

        function updateZoom() {
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
            if (currentMode === 'mermaid') {
                document.getElementById('mermaid-output').style.transform = `scale(${zoomLevel})`;
            } else if (bpmnViewer) {
                bpmnViewer.get('canvas').zoom(zoomLevel);
            }
        }

        // Resizer
        function initResizer() {
            const handle = document.getElementById('resizeHandle');
            const panel = document.getElementById('editorPanel');
            let startX, startWidth;

            handle.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                startWidth = panel.offsetWidth;
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });

            function resize(e) {
                const newWidth = startWidth + (e.clientX - startX);
                if (newWidth > 250 && newWidth < window.innerWidth - 300) {
                    panel.style.width = newWidth + 'px';
                }
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }
    </script>
</body>
</html>

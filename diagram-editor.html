<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BPMN 2.0 Editor</title>
        <script src="https://cdn.jsdelivr.net/npm/bpmn-js@17.2.0/dist/bpmn-navigated-viewer.production.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <style>
            /* ═══════════════════════════════════════════════════════════════════════
           AMI DESIGN TOKENS
           ═══════════════════════════════════════════════════════════════════════ */
            :root {
                /* Gray Scale */
                --gray-950: #0f1419;
                --gray-900: #1a1f26;
                --gray-800: #2d333b;
                --gray-700: #424a55;
                --gray-600: #57606a;
                --gray-500: #6e7781;
                --gray-400: #8b949e;
                --gray-300: #afb8c1;
                --gray-200: #d0d7de;
                --gray-100: #eaeef2;
                --gray-50: #f6f8fa;

                /* Indigo — Primary */
                --indigo-950: #1e1b4b;
                --indigo-900: #312e81;
                --indigo-800: #3730a3;
                --indigo-700: #4338ca;
                --indigo-600: #4f46e5;
                --indigo-500: #6366f1;
                --indigo-400: #818cf8;
                --indigo-300: #a5b4fc;
                --indigo-200: #c7d2fe;
                --indigo-100: #e0e7ff;
                --indigo-50: #eef2ff;

                /* Semantic */
                --green-600: #16a34a;
                --green-100: #dcfce7;
                --amber-600: #d97706;
                --amber-100: #fef3c7;
                --red-600: #dc2626;
                --red-100: #fee2e2;

                --white: #ffffff;

                /* Light Theme Tokens */
                --bg-page: var(--white);
                --bg-surface: var(--white);
                --bg-subtle: var(--gray-50);
                --bg-muted: var(--gray-100);
                --bg-input: var(--white);

                --text-primary: var(--gray-900);
                --text-secondary: var(--gray-600);
                --text-muted: var(--gray-500);

                --border-default: var(--gray-200);
                --border-subtle: var(--gray-100);
                --border-strong: var(--gray-300);

                --accent: var(--indigo-600);
                --accent-hover: var(--indigo-700);
                --accent-subtle: var(--indigo-50);
                --accent-muted: var(--indigo-100);

                --success: var(--green-600);
                --warning: var(--amber-600);
                --error: var(--red-600);

                /* Typography */
                --font-sans:
                    "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
                    system-ui, sans-serif;
                --font-serif: "Source Serif 4", "Georgia", serif;
                --font-mono: "JetBrains Mono", "SF Mono", monospace;

                /* Spacing */
                --space-1: 0.25rem;
                --space-2: 0.5rem;
                --space-3: 0.75rem;
                --space-4: 1rem;
                --space-5: 1.25rem;
                --space-6: 1.5rem;
                --space-8: 2rem;

                /* Borders */
                --radius-sm: 4px;
                --radius-md: 6px;
                --radius-lg: 8px;
                --radius-xl: 12px;
                --radius-full: 9999px;

                /* Shadows */
                --shadow-sm:
                    0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
                --shadow-md:
                    0 4px 6px -1px rgba(0, 0, 0, 0.1),
                    0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg:
                    0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --shadow-xl:
                    0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);

                /* Motion */
                --duration-fast: 150ms;
                --duration-normal: 200ms;
                --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
                --ease-out: cubic-bezier(0, 0, 0.2, 1);
            }

            /* Eye Gentle Theme */
            [data-theme="gentle"] {
                --bg-page: #faf9f7;
                --bg-surface: #fdfcfa;
                --bg-subtle: #f5f4f1;
                --bg-muted: #eeedea;
                --bg-input: #fdfcfa;

                --text-primary: #374151;
                --text-secondary: #6b7280;
                --text-muted: #9ca3af;

                --border-default: #e5e3df;
                --border-subtle: #eeedea;
                --border-strong: #d1cfc9;

                --accent: #6366f1;
                --accent-subtle: #f0f0ff;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           RESET & BASE
           ═══════════════════════════════════════════════════════════════════════ */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html,
            body {
                height: 100%;
                overflow: hidden;
            }

            body {
                font-family: var(--font-sans);
                background-color: var(--bg-page);
                color: var(--text-primary);
                line-height: 1.5;
                -webkit-font-smoothing: antialiased;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           LAYOUT
           ═══════════════════════════════════════════════════════════════════════ */
            .app {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           HEADER
           ═══════════════════════════════════════════════════════════════════════ */
            .header {
                height: 56px;
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-default);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 var(--space-4);
                flex-shrink: 0;
                box-shadow: var(--shadow-sm);
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: var(--space-3);
            }

            .logo {
                display: flex;
                align-items: center;
                gap: var(--space-2);
                font-weight: 700;
                font-size: 0.9375rem;
                color: var(--text-primary);
                letter-spacing: -0.01em;
            }

            .logo-mark {
                width: 32px;
                height: 32px;
                background: linear-gradient(
                    135deg,
                    var(--indigo-500),
                    var(--indigo-600)
                );
                border-radius: var(--radius-lg);
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: var(--shadow-sm);
            }

            .logo-mark svg {
                width: 18px;
                height: 18px;
                color: white;
            }

            .version-badge {
                font-family: var(--font-mono);
                font-size: 0.6875rem;
                font-weight: 500;
                padding: var(--space-1) var(--space-2);
                background: var(--accent-subtle);
                border: 1px solid var(--accent-muted);
                border-radius: var(--radius-full);
                color: var(--accent);
                letter-spacing: 0.02em;
            }

            .header-actions {
                display: flex;
                align-items: center;
                gap: var(--space-2);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           BUTTONS
           ═══════════════════════════════════════════════════════════════════════ */
            .btn {
                display: inline-flex;
                align-items: center;
                gap: var(--space-2);
                padding: var(--space-2) var(--space-3);
                font-size: 0.8125rem;
                font-weight: 500;
                font-family: var(--font-sans);
                border-radius: var(--radius-md);
                border: 1px solid var(--border-default);
                background: var(--bg-surface);
                color: var(--text-secondary);
                cursor: pointer;
                transition: all var(--duration-fast) var(--ease-default);
            }

            .btn:hover {
                background: var(--bg-subtle);
                border-color: var(--border-strong);
                color: var(--text-primary);
            }

            .btn svg {
                width: 16px;
                height: 16px;
            }

            .btn-primary {
                background: var(--accent);
                border-color: var(--accent);
                color: white;
            }

            .btn-primary:hover {
                background: var(--accent-hover);
                border-color: var(--accent-hover);
            }

            .btn-icon {
                width: 34px;
                height: 34px;
                padding: 0;
                justify-content: center;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           DROPDOWN
           ═══════════════════════════════════════════════════════════════════════ */
            .dropdown {
                position: relative;
            }

            .dropdown-menu {
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: var(--space-1);
                min-width: 200px;
                background: var(--bg-surface);
                border: 1px solid var(--border-default);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                display: none;
            }

            .dropdown-menu.open {
                display: block;
            }

            .dropdown-item {
                display: flex;
                align-items: center;
                gap: var(--space-2);
                padding: var(--space-2) var(--space-3);
                font-size: 0.8125rem;
                color: var(--text-secondary);
                cursor: pointer;
                border-bottom: 1px solid var(--border-subtle);
                transition: all var(--duration-fast) var(--ease-default);
            }

            .dropdown-item:last-child {
                border-bottom: none;
            }

            .dropdown-item:hover {
                background: var(--accent-subtle);
                color: var(--accent);
            }

            .dropdown-item svg {
                width: 16px;
                height: 16px;
                opacity: 0.7;
            }

            .dropdown-category {
                padding: var(--space-2) var(--space-3);
                font-family: var(--font-mono);
                font-size: 0.625rem;
                text-transform: uppercase;
                color: var(--text-muted);
                background: var(--bg-subtle);
                font-weight: 600;
                letter-spacing: 0.1em;
            }

            .dropdown-divider {
                height: 1px;
                background: var(--border-default);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           MAIN CONTENT
           ═══════════════════════════════════════════════════════════════════════ */
            .main {
                flex: 1;
                display: flex;
                overflow: hidden;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           EDITOR PANEL
           ═══════════════════════════════════════════════════════════════════════ */
            .editor-panel {
                width: 50%;
                min-width: 400px;
                display: flex;
                flex-direction: column;
                border-right: 1px solid var(--border-default);
                background: var(--bg-subtle);
            }

            .panel-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: var(--space-2) var(--space-3);
                border-bottom: 1px solid var(--border-default);
                background: var(--bg-surface);
            }

            .panel-title {
                font-family: var(--font-mono);
                font-size: 0.6875rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: var(--text-muted);
            }

            .panel-actions {
                display: flex;
                gap: var(--space-1);
            }

            .panel-action {
                width: 26px;
                height: 26px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                background: transparent;
                color: var(--text-muted);
                cursor: pointer;
                border-radius: var(--radius-sm);
                transition: all var(--duration-fast) var(--ease-default);
            }

            .panel-action:hover {
                background: var(--bg-muted);
                color: var(--text-primary);
            }

            .panel-action svg {
                width: 14px;
                height: 14px;
            }

            .editor-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .code-editor {
                flex: 1;
                padding: var(--space-3);
                background: var(--bg-input);
                border: none;
                resize: none;
                font-family: var(--font-mono);
                font-size: 0.8125rem;
                line-height: 1.7;
                color: var(--text-primary);
                outline: none;
                overflow: auto;
            }

            .code-editor::placeholder {
                color: var(--text-muted);
            }

            .code-editor:focus {
                background: var(--bg-surface);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           REFERENCE PANEL
           ═══════════════════════════════════════════════════════════════════════ */
            .reference-panel {
                border-top: 1px solid var(--border-default);
                background: var(--bg-surface);
                max-height: 45%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .reference-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: var(--space-2) var(--space-3);
                border-bottom: 1px solid var(--border-default);
                flex-shrink: 0;
                background: var(--bg-subtle);
            }

            .reference-tabs {
                display: flex;
                gap: var(--space-1);
            }

            .reference-tab {
                padding: var(--space-1) var(--space-2);
                font-size: 0.6875rem;
                font-weight: 600;
                border: none;
                background: transparent;
                color: var(--text-muted);
                cursor: pointer;
                border-radius: var(--radius-sm);
                font-family: var(--font-sans);
                transition: all var(--duration-fast) var(--ease-default);
            }

            .reference-tab:hover {
                color: var(--text-secondary);
                background: var(--bg-muted);
            }

            .reference-tab.active {
                background: var(--accent);
                color: white;
            }

            .reference-content {
                flex: 1;
                overflow-y: auto;
                padding: var(--space-3);
            }

            .ref-section {
                margin-bottom: var(--space-4);
            }

            .ref-section:last-child {
                margin-bottom: 0;
            }

            .ref-section-title {
                font-family: var(--font-mono);
                font-size: 0.625rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: var(--text-muted);
                margin-bottom: var(--space-2);
                padding-bottom: var(--space-1);
                border-bottom: 1px solid var(--border-subtle);
            }

            .ref-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: var(--space-1);
            }

            .ref-item {
                display: flex;
                align-items: center;
                gap: var(--space-2);
                padding: var(--space-2);
                border-radius: var(--radius-md);
                cursor: pointer;
                transition: all var(--duration-fast) var(--ease-default);
            }

            .ref-item:hover {
                background: var(--accent-subtle);
            }

            .ref-item:active {
                transform: scale(0.98);
            }

            .ref-item code {
                font-family: var(--font-mono);
                font-size: 0.6875rem;
                padding: var(--space-1) var(--space-2);
                background: var(--bg-muted);
                border-radius: var(--radius-sm);
                color: var(--accent);
                white-space: nowrap;
            }

            .ref-item:hover code {
                background: var(--accent);
                color: white;
            }

            .ref-item span {
                font-size: 0.6875rem;
                color: var(--text-secondary);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           PREVIEW PANEL
           ═══════════════════════════════════════════════════════════════════════ */
            .preview-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: var(--bg-page);
            }

            .preview-toolbar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: var(--space-2) var(--space-3);
                border-bottom: 1px solid var(--border-default);
                background: var(--bg-surface);
            }

            .zoom-controls {
                display: flex;
                align-items: center;
                gap: var(--space-1);
            }

            .zoom-btn {
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border-default);
                background: var(--bg-surface);
                color: var(--text-secondary);
                cursor: pointer;
                border-radius: var(--radius-md);
                font-size: 14px;
                transition: all var(--duration-fast) var(--ease-default);
            }

            .zoom-btn:hover {
                background: var(--bg-subtle);
                color: var(--text-primary);
                border-color: var(--border-strong);
            }

            .zoom-level {
                font-family: var(--font-mono);
                font-size: 0.75rem;
                color: var(--text-muted);
                min-width: 50px;
                text-align: center;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           SUBPROCESS BREADCRUMB NAVIGATION
           ═══════════════════════════════════════════════════════════════════════ */
            .breadcrumb-bar {
                display: flex;
                align-items: center;
                gap: var(--space-2);
                padding: var(--space-2) var(--space-4);
                background: linear-gradient(
                    to right,
                    var(--accent-subtle),
                    var(--bg-subtle)
                );
                border-bottom: 1px solid var(--border-default);
                animation: slideDown 0.2s var(--ease-out);
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-100%);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .breadcrumb-back {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                border: 1px solid var(--accent);
                background: var(--bg-surface);
                color: var(--accent);
                cursor: pointer;
                border-radius: var(--radius-md);
                transition: all var(--duration-fast) var(--ease-default);
                flex-shrink: 0;
            }

            .breadcrumb-back:hover {
                background: var(--accent);
                color: white;
            }

            .breadcrumb-path {
                display: flex;
                align-items: center;
                gap: var(--space-1);
                flex: 1;
                overflow-x: auto;
                font-size: 0.8125rem;
            }

            .breadcrumb-item {
                display: flex;
                align-items: center;
                gap: var(--space-1);
                white-space: nowrap;
            }

            .breadcrumb-item button {
                padding: var(--space-1) var(--space-2);
                border: none;
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                border-radius: var(--radius-sm);
                font-family: var(--font-sans);
                font-size: 0.8125rem;
                transition: all var(--duration-fast) var(--ease-default);
            }

            .breadcrumb-item button:hover {
                background: var(--bg-muted);
                color: var(--text-primary);
            }

            .breadcrumb-item.current button {
                background: var(--accent);
                color: white;
                font-weight: 500;
                cursor: default;
            }

            .breadcrumb-separator {
                color: var(--text-muted);
                font-size: 0.75rem;
            }

            .breadcrumb-hint {
                font-family: var(--font-mono);
                font-size: 0.625rem;
                color: var(--text-muted);
                background: var(--bg-muted);
                padding: 2px 6px;
                border-radius: var(--radius-sm);
                margin-left: auto;
                flex-shrink: 0;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           NAVIGATION CONTROLS
           ═══════════════════════════════════════════════════════════════════════ */
            .nav-controls {
                position: absolute;
                bottom: var(--space-4);
                right: var(--space-4);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                z-index: 100;
            }

            .nav-row {
                display: flex;
                gap: 2px;
            }

            .nav-btn {
                width: 38px;
                height: 38px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border-default);
                background: var(--bg-surface);
                color: var(--text-secondary);
                cursor: pointer;
                border-radius: var(--radius-lg);
                font-size: 16px;
                transition: all var(--duration-fast) var(--ease-default);
                box-shadow: var(--shadow-md);
            }

            .nav-btn:hover {
                background: var(--bg-subtle);
                color: var(--accent);
                border-color: var(--accent);
            }

            .nav-btn:active {
                transform: scale(0.95);
                background: var(--accent);
                color: white;
            }

            .nav-btn svg {
                width: 18px;
                height: 18px;
            }

            .nav-center {
                width: 38px;
                height: 38px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border-default);
                background: var(--bg-muted);
                color: var(--text-muted);
                border-radius: var(--radius-lg);
                font-size: 10px;
                cursor: pointer;
                transition: all var(--duration-fast) var(--ease-default);
            }

            .nav-center:hover {
                background: var(--accent);
                color: white;
                border-color: var(--accent);
            }

            .preview-container {
                flex: 1;
                overflow: auto;
                background: var(--white);
                position: relative;
            }

            #bpmn-canvas {
                width: 100%;
                height: 100%;
                min-height: 500px;
                cursor: grab;
            }

            #bpmn-canvas:active {
                cursor: grabbing;
            }

            .preview-error {
                margin: var(--space-6);
                padding: var(--space-4);
                background: var(--red-100);
                border: 1px solid var(--error);
                border-radius: var(--radius-lg);
                color: var(--error);
            }

            .preview-error-title {
                font-weight: 600;
                margin-bottom: var(--space-1);
            }

            .preview-error-message {
                font-family: var(--font-mono);
                font-size: 0.75rem;
                opacity: 0.9;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           RESIZE HANDLE
           ═══════════════════════════════════════════════════════════════════════ */
            .resize-handle {
                width: 4px;
                background: var(--border-default);
                cursor: col-resize;
                transition: background var(--duration-fast) var(--ease-default);
                flex-shrink: 0;
            }

            .resize-handle:hover {
                background: var(--accent);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           STATUS BAR
           ═══════════════════════════════════════════════════════════════════════ */
            .status-bar {
                height: 28px;
                background: var(--bg-surface);
                border-top: 1px solid var(--border-default);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 var(--space-3);
                font-size: 0.6875rem;
                color: var(--text-muted);
            }

            .status-item {
                display: flex;
                align-items: center;
                gap: var(--space-2);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: var(--radius-full);
                background: var(--success);
            }

            .status-dot.error {
                background: var(--error);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           THEME TOGGLE
           ═══════════════════════════════════════════════════════════════════════ */
            .theme-toggle .icon-moon {
                display: none;
            }

            [data-theme="gentle"] .theme-toggle .icon-sun {
                display: none;
            }

            [data-theme="gentle"] .theme-toggle .icon-moon {
                display: block;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           TOAST NOTIFICATIONS
           ═══════════════════════════════════════════════════════════════════════ */
            .toast {
                position: fixed;
                bottom: 40px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                padding: var(--space-3) var(--space-4);
                background: var(--bg-surface);
                border: 1px solid var(--border-default);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                font-size: 0.8125rem;
                color: var(--text-primary);
                opacity: 0;
                transition: all 0.3s var(--ease-out);
                z-index: 10000;
            }

            .toast.show {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           SCROLLBAR
           ═══════════════════════════════════════════════════════════════════════ */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--border-default);
                border-radius: var(--radius-full);
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--border-strong);
            }

            /* ═══════════════════════════════════════════════════════════════════════
           FILE INPUT
           ═══════════════════════════════════════════════════════════════════════ */
            .file-input {
                display: none;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           SEARCH
           ═══════════════════════════════════════════════════════════════════════ */
            .search-container {
                position: relative;
                display: flex;
                align-items: center;
            }

            .search-input {
                width: 180px;
                padding: var(--space-2) var(--space-3) var(--space-2) 32px;
                background: var(--bg-subtle);
                border: 1px solid var(--border-default);
                border-radius: var(--radius-md);
                color: var(--text-primary);
                font-size: 0.8125rem;
                font-family: var(--font-sans);
                transition: all var(--duration-normal) var(--ease-default);
            }

            .search-input:focus {
                outline: none;
                border-color: var(--accent);
                background: var(--bg-surface);
                width: 240px;
                box-shadow: 0 0 0 3px var(--accent-subtle);
            }

            .search-input::placeholder {
                color: var(--text-muted);
            }

            .search-icon {
                position: absolute;
                left: 10px;
                width: 14px;
                height: 14px;
                color: var(--text-muted);
                pointer-events: none;
            }

            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                margin-top: var(--space-1);
                background: var(--bg-surface);
                border: 1px solid var(--border-default);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            }

            .search-results.open {
                display: block;
            }

            .search-result-item {
                padding: var(--space-2) var(--space-3);
                cursor: pointer;
                border-bottom: 1px solid var(--border-subtle);
                display: flex;
                align-items: center;
                gap: var(--space-2);
                transition: all var(--duration-fast) var(--ease-default);
            }

            .search-result-item:last-child {
                border-bottom: none;
            }

            .search-result-item:hover {
                background: var(--accent-subtle);
            }

            .search-result-item.selected {
                background: var(--accent);
                color: white;
            }

            .search-result-type {
                font-family: var(--font-mono);
                font-size: 0.625rem;
                padding: var(--space-1) var(--space-2);
                border-radius: var(--radius-sm);
                background: var(--bg-muted);
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .search-result-item.selected .search-result-type {
                background: rgba(255, 255, 255, 0.2);
                color: white;
            }

            .search-result-name {
                flex: 1;
                font-size: 0.8125rem;
            }

            .search-no-results {
                padding: var(--space-3);
                text-align: center;
                color: var(--text-muted);
                font-size: 0.8125rem;
            }

            /* ═══════════════════════════════════════════════════════════════════════
           AUTO-SAVE INDICATOR
           ═══════════════════════════════════════════════════════════════════════ */
            .autosave-indicator {
                font-size: 0.6875rem;
                color: var(--text-muted);
                display: flex;
                align-items: center;
                gap: var(--space-1);
            }

            .autosave-indicator.saving {
                color: var(--warning);
            }

            .autosave-indicator.saved {
                color: var(--success);
            }
        </style>
    </head>
    <body>
        <div class="app">
            <header class="header">
                <div class="header-left">
                    <div class="logo">
                        <div class="logo-mark">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2.5"
                            >
                                <rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                />
                                <path d="M9 9h6v6H9z" />
                            </svg>
                        </div>
                        <span>BPMN 2.0 Editor</span>
                    </div>
                    <span class="version-badge">Version 1.1</span>
                </div>

                <div class="header-actions">
                    <!-- Search -->
                    <div class="search-container">
                        <svg
                            class="search-icon"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <circle cx="11" cy="11" r="8" />
                            <path d="M21 21l-4.35-4.35" />
                        </svg>
                        <input
                            type="text"
                            class="search-input"
                            id="searchInput"
                            placeholder="Search elements..."
                            autocomplete="off"
                        />
                        <div class="search-results" id="searchResults"></div>
                    </div>

                    <div class="dropdown">
                        <button
                            class="btn"
                            onclick="toggleDropdown('examplesMenu')"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                                <path
                                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                                />
                            </svg>
                            Templates
                        </button>
                        <div
                            class="dropdown-menu"
                            id="examplesMenu"
                            style="
                                max-height: 400px;
                                overflow-y: auto;
                                width: 240px;
                            "
                        >
                            <div class="dropdown-category">Test / Debug</div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('flowtest')"
                            >
                                Flow Types Test
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-category">Getting Started</div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('simple')"
                            >
                                Simple Order Process
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('gateways')"
                            >
                                All Gateway Types
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('events')"
                            >
                                Event Types
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('tasks')"
                            >
                                Task Types
                            </div>

                            <div class="dropdown-divider"></div>
                            <div class="dropdown-category">
                                Enterprise Patterns
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('approval')"
                            >
                                Approval Workflow
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('exception')"
                            >
                                Exception Handling
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('escalation')"
                            >
                                Escalation Process
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('compensation')"
                            >
                                Compensation (Saga)
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('retry')"
                            >
                                Retry Pattern
                            </div>

                            <div class="dropdown-divider"></div>
                            <div class="dropdown-category">
                                Industry Templates
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('onboarding')"
                            >
                                Employee Onboarding
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('invoice')"
                            >
                                Invoice Processing
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('incident')"
                            >
                                Incident Management
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('change')"
                            >
                                Change Request (ITIL)
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('kyc')"
                            >
                                KYC Verification
                            </div>

                            <div class="dropdown-divider"></div>
                            <div class="dropdown-category">Advanced</div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('pools')"
                            >
                                Multi-Pool Collaboration
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('subprocess')"
                            >
                                Sub-Process Patterns
                            </div>
                            <div
                                class="dropdown-item"
                                onclick="loadExample('complete')"
                            >
                                Complete Demo
                            </div>
                        </div>
                    </div>

                    <label class="btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                            />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        Import
                        <input
                            type="file"
                            class="file-input"
                            id="fileInput"
                            accept=".bpmn,.xml,.txt"
                            onchange="importFile(event)"
                        />
                    </label>

                    <div class="dropdown">
                        <button
                            class="btn btn-primary"
                            onclick="toggleDropdown('exportMenu')"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                                />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Export
                        </button>
                        <div class="dropdown-menu" id="exportMenu">
                            <div class="dropdown-item" onclick="exportBPMN()">
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                                    />
                                    <polyline points="14 2 14 8 20 8" />
                                </svg>
                                BPMN 2.0 XML (Signavio)
                            </div>
                            <div class="dropdown-item" onclick="exportSVG()">
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <rect
                                        x="3"
                                        y="3"
                                        width="18"
                                        height="18"
                                        rx="2"
                                    />
                                    <circle cx="8.5" cy="8.5" r="1.5" />
                                    <polyline points="21 15 16 10 5 21" />
                                </svg>
                                SVG Image
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="main">
                <div class="editor-panel" id="editorPanel">
                    <div class="panel-header">
                        <span class="panel-title">DSL Editor</span>
                        <div class="panel-actions">
                            <button
                                class="panel-action"
                                onclick="copyCode()"
                                title="Copy"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <rect
                                        x="9"
                                        y="9"
                                        width="13"
                                        height="13"
                                        rx="2"
                                    />
                                    <path
                                        d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                                    />
                                </svg>
                            </button>
                            <button
                                class="panel-action"
                                onclick="clearEditor()"
                                title="Clear"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <polyline points="3 6 5 6 21 6" />
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                                    />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="editor-container">
                        <textarea
                            class="code-editor"
                            id="codeEditor"
                            placeholder="Enter BPMN DSL code here..."
                            spellcheck="false"
                        ></textarea>
                    </div>

                    <div class="reference-panel" id="referencePanel">
                        <div class="reference-header">
                            <span class="panel-title">Syntax Reference</span>
                            <div class="reference-tabs">
                                <button
                                    class="reference-tab active"
                                    onclick="setRefTab('events')"
                                >
                                    Events
                                </button>
                                <button
                                    class="reference-tab"
                                    onclick="setRefTab('activities')"
                                >
                                    Activities
                                </button>
                                <button
                                    class="reference-tab"
                                    onclick="setRefTab('gateways')"
                                >
                                    Gateways
                                </button>
                                <button
                                    class="reference-tab"
                                    onclick="setRefTab('data')"
                                >
                                    Data
                                </button>
                                <button
                                    class="reference-tab"
                                    onclick="setRefTab('pools')"
                                >
                                    Pools
                                </button>
                            </div>
                        </div>
                        <div class="reference-content" id="referenceContent">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                </div>

                <div class="resize-handle" id="resizeHandle"></div>

                <div class="preview-panel">
                    <div class="preview-toolbar">
                        <span class="panel-title">Preview</span>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoomOut()">
                                −
                            </button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                            <button class="zoom-btn" onclick="zoomIn()">
                                +
                            </button>
                            <button
                                class="zoom-btn"
                                onclick="fitView()"
                                title="Fit to view"
                            >
                                ⊡
                            </button>
                        </div>
                    </div>

                    <!-- Subprocess Navigation Breadcrumb -->
                    <div
                        class="breadcrumb-bar"
                        id="breadcrumbBar"
                        style="display: none"
                    >
                        <button
                            class="breadcrumb-back"
                            onclick="navigateToParent()"
                            title="Back to parent (Esc)"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                width="16"
                                height="16"
                            >
                                <path d="M19 12H5M12 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <div class="breadcrumb-path" id="breadcrumbPath">
                            <!-- Breadcrumb items inserted dynamically -->
                        </div>
                    </div>

                    <div class="preview-container">
                        <div id="bpmn-canvas"></div>

                        <!-- Navigation Controls -->
                        <div class="nav-controls">
                            <div class="nav-row">
                                <button
                                    class="nav-btn"
                                    onclick="panCanvas(0, -80)"
                                    title="Pan Up"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <path d="M12 19V5M5 12l7-7 7 7" />
                                    </svg>
                                </button>
                            </div>
                            <div class="nav-row">
                                <button
                                    class="nav-btn"
                                    onclick="panCanvas(-80, 0)"
                                    title="Pan Left"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <path d="M19 12H5M12 5l-7 7 7 7" />
                                    </svg>
                                </button>
                                <button
                                    class="nav-center"
                                    onclick="resetView()"
                                    title="Reset View"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <circle cx="12" cy="12" r="3" />
                                        <path
                                            d="M12 2v2M12 20v2M2 12h2M20 12h2"
                                        />
                                    </svg>
                                </button>
                                <button
                                    class="nav-btn"
                                    onclick="panCanvas(80, 0)"
                                    title="Pan Right"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <path d="M5 12h14M12 5l7 7-7 7" />
                                    </svg>
                                </button>
                            </div>
                            <div class="nav-row">
                                <button
                                    class="nav-btn"
                                    onclick="panCanvas(0, 80)"
                                    title="Pan Down"
                                >
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <path d="M12 5v14M5 12l7 7 7-7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Ready</span>
                </div>
                <div
                    class="status-item autosave-indicator"
                    id="autosaveIndicator"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        width="12"
                        height="12"
                    >
                        <path
                            d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                        />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    <span id="autosaveText">Auto-save enabled</span>
                </div>
                <div class="status-item">
                    <span id="elementCount">0 elements</span>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            // ============================================================
            // STATE
            // ============================================================
            let bpmnViewer = null;
            let lastBpmnXml = null;
            let debounceTimer = null;
            let zoomLevel = 1;
            let currentRefTab = "events";

            // Subprocess navigation stack
            let navigationStack = [];
            let currentRootElement = null;

            // ============================================================
            // BPMN 2.0 COMPLETE ELEMENT DEFINITIONS
            // ============================================================

            // All Start Event Types
            const START_EVENTS = {
                "(start)": {
                    type: "startEvent",
                    trigger: null,
                    label: "None Start",
                },
                "(start:message)": {
                    type: "startEvent",
                    trigger: "messageEventDefinition",
                    label: "Message Start",
                },
                "(start:timer)": {
                    type: "startEvent",
                    trigger: "timerEventDefinition",
                    label: "Timer Start",
                },
                "(start:conditional)": {
                    type: "startEvent",
                    trigger: "conditionalEventDefinition",
                    label: "Conditional Start",
                },
                "(start:signal)": {
                    type: "startEvent",
                    trigger: "signalEventDefinition",
                    label: "Signal Start",
                },
                "(start:multiple)": {
                    type: "startEvent",
                    trigger: "multipleEventDefinition",
                    label: "Multiple Start",
                },
                "(start:parallel)": {
                    type: "startEvent",
                    trigger: "parallelMultipleEventDefinition",
                    label: "Parallel Multiple Start",
                },
                "(start:error)": {
                    type: "startEvent",
                    trigger: "errorEventDefinition",
                    label: "Error Start (Event Sub)",
                },
                "(start:escalation)": {
                    type: "startEvent",
                    trigger: "escalationEventDefinition",
                    label: "Escalation Start (Event Sub)",
                },
                "(start:compensation)": {
                    type: "startEvent",
                    trigger: "compensateEventDefinition",
                    label: "Compensation Start (Event Sub)",
                },
            };

            // All Intermediate Catch Events
            const CATCH_EVENTS = {
                "(catch:message)": {
                    type: "intermediateCatchEvent",
                    trigger: "messageEventDefinition",
                    label: "Message Catch",
                },
                "(catch:timer)": {
                    type: "intermediateCatchEvent",
                    trigger: "timerEventDefinition",
                    label: "Timer Catch",
                },
                "(timer)": {
                    type: "intermediateCatchEvent",
                    trigger: "timerEventDefinition",
                    label: "Timer (shorthand)",
                },
                "(catch:conditional)": {
                    type: "intermediateCatchEvent",
                    trigger: "conditionalEventDefinition",
                    label: "Conditional Catch",
                },
                "(catch:signal)": {
                    type: "intermediateCatchEvent",
                    trigger: "signalEventDefinition",
                    label: "Signal Catch",
                },
                "(catch:link)": {
                    type: "intermediateCatchEvent",
                    trigger: "linkEventDefinition",
                    label: "Link Catch",
                },
                "(catch:multiple)": {
                    type: "intermediateCatchEvent",
                    trigger: "multipleEventDefinition",
                    label: "Multiple Catch",
                },
                "(catch:parallel)": {
                    type: "intermediateCatchEvent",
                    trigger: "parallelMultipleEventDefinition",
                    label: "Parallel Multiple Catch",
                },
            };

            // All Intermediate Throw Events
            const THROW_EVENTS = {
                "(throw)": {
                    type: "intermediateThrowEvent",
                    trigger: null,
                    label: "None Throw",
                },
                "(throw:message)": {
                    type: "intermediateThrowEvent",
                    trigger: "messageEventDefinition",
                    label: "Message Throw",
                },
                "(throw:signal)": {
                    type: "intermediateThrowEvent",
                    trigger: "signalEventDefinition",
                    label: "Signal Throw",
                },
                "(throw:escalation)": {
                    type: "intermediateThrowEvent",
                    trigger: "escalationEventDefinition",
                    label: "Escalation Throw",
                },
                "(throw:compensation)": {
                    type: "intermediateThrowEvent",
                    trigger: "compensateEventDefinition",
                    label: "Compensation Throw",
                },
                "(throw:link)": {
                    type: "intermediateThrowEvent",
                    trigger: "linkEventDefinition",
                    label: "Link Throw",
                },
                "(throw:multiple)": {
                    type: "intermediateThrowEvent",
                    trigger: "multipleEventDefinition",
                    label: "Multiple Throw",
                },
            };

            // All End Event Types
            const END_EVENTS = {
                "(end)": { type: "endEvent", trigger: null, label: "None End" },
                "(end:message)": {
                    type: "endEvent",
                    trigger: "messageEventDefinition",
                    label: "Message End",
                },
                "(end:signal)": {
                    type: "endEvent",
                    trigger: "signalEventDefinition",
                    label: "Signal End",
                },
                "(end:error)": {
                    type: "endEvent",
                    trigger: "errorEventDefinition",
                    label: "Error End",
                },
                "(error)": {
                    type: "endEvent",
                    trigger: "errorEventDefinition",
                    label: "Error (shorthand)",
                },
                "(end:escalation)": {
                    type: "endEvent",
                    trigger: "escalationEventDefinition",
                    label: "Escalation End",
                },
                "(end:cancel)": {
                    type: "endEvent",
                    trigger: "cancelEventDefinition",
                    label: "Cancel End",
                },
                "(end:compensation)": {
                    type: "endEvent",
                    trigger: "compensateEventDefinition",
                    label: "Compensation End",
                },
                "(end:terminate)": {
                    type: "endEvent",
                    trigger: "terminateEventDefinition",
                    label: "Terminate End",
                },
                "(terminate)": {
                    type: "endEvent",
                    trigger: "terminateEventDefinition",
                    label: "Terminate (shorthand)",
                },
                "(end:multiple)": {
                    type: "endEvent",
                    trigger: "multipleEventDefinition",
                    label: "Multiple End",
                },
            };

            // Boundary Events (attached to tasks)
            const BOUNDARY_TRIGGERS = {
                message: "messageEventDefinition",
                timer: "timerEventDefinition",
                conditional: "conditionalEventDefinition",
                signal: "signalEventDefinition",
                error: "errorEventDefinition",
                escalation: "escalationEventDefinition",
                cancel: "cancelEventDefinition",
                compensation: "compensateEventDefinition",
                multiple: "multipleEventDefinition",
                parallel: "parallelMultipleEventDefinition",
            };

            // All Task Types
            const TASK_TYPES = {
                "": { type: "task", label: "Abstract Task" },
                "task:": { type: "task", label: "Task" },
                "user:": { type: "userTask", label: "User Task" },
                "service:": { type: "serviceTask", label: "Service Task" },
                "script:": { type: "scriptTask", label: "Script Task" },
                "rule:": {
                    type: "businessRuleTask",
                    label: "Business Rule Task",
                },
                "send:": { type: "sendTask", label: "Send Task" },
                "receive:": { type: "receiveTask", label: "Receive Task" },
                "manual:": { type: "manualTask", label: "Manual Task" },
            };

            // Sub-Process Types
            const SUBPROCESS_TYPES = {
                "sub:": { type: "subProcess", label: "Sub-Process" },
                "event-sub:": {
                    type: "subProcess",
                    triggeredByEvent: true,
                    label: "Event Sub-Process",
                },
                "transaction:": { type: "transaction", label: "Transaction" },
                "adhoc:": {
                    type: "adHocSubProcess",
                    label: "Ad-Hoc Sub-Process",
                },
                "call:": { type: "callActivity", label: "Call Activity" },
            };

            // Task Markers
            const TASK_MARKERS = {
                "~loop": {
                    loopCharacteristics: "standardLoopCharacteristics",
                    label: "Loop",
                },
                "~parallel": {
                    loopCharacteristics: "multiInstanceLoopCharacteristics",
                    isSequential: false,
                    label: "Parallel MI",
                },
                "~sequential": {
                    loopCharacteristics: "multiInstanceLoopCharacteristics",
                    isSequential: true,
                    label: "Sequential MI",
                },
                "~compensation": {
                    isForCompensation: true,
                    label: "Compensation",
                },
            };

            // All Gateway Types
            const GATEWAY_TYPES = {
                "<": { type: "exclusiveGateway", label: "Exclusive (XOR)" },
                "<x": { type: "exclusiveGateway", label: "Exclusive (XOR)" },
                "<+": { type: "parallelGateway", label: "Parallel (AND)" },
                "<o": { type: "inclusiveGateway", label: "Inclusive (OR)" },
                "<*": { type: "complexGateway", label: "Complex" },
                "<@": { type: "eventBasedGateway", label: "Event-Based" },
                "<@+": {
                    type: "eventBasedGateway",
                    instantiate: true,
                    label: "Event-Based (Instantiating)",
                },
                "<@x": {
                    type: "eventBasedGateway",
                    exclusive: true,
                    label: "Exclusive Event-Based",
                },
            };

            // Data Elements
            const DATA_TYPES = {
                "{data:": { type: "dataObjectReference", label: "Data Object" },
                "{input:": { type: "dataInput", label: "Data Input" },
                "{output:": { type: "dataOutput", label: "Data Output" },
                "{store:": { type: "dataStoreReference", label: "Data Store" },
                "{collection:": {
                    type: "dataObjectReference",
                    isCollection: true,
                    label: "Data Collection",
                },
            };

            // Merge all events for parsing
            const ALL_EVENTS = {
                ...START_EVENTS,
                ...CATCH_EVENTS,
                ...THROW_EVENTS,
                ...END_EVENTS,
            };

            // ============================================================
            // REFERENCE PANEL DATA
            // ============================================================
            const REFERENCE_DATA = {
                events: {
                    "Start Events": [
                        { code: "(start)", desc: "None Start" },
                        { code: "(start:message)", desc: "Message Start" },
                        { code: "(start:timer)", desc: "Timer Start" },
                        { code: "(start:signal)", desc: "Signal Start" },
                        {
                            code: "(start:conditional)",
                            desc: "Conditional Start",
                        },
                        { code: "(start:error)", desc: "Error Start" },
                        {
                            code: "(start:escalation)",
                            desc: "Escalation Start",
                        },
                        {
                            code: "(start:compensation)",
                            desc: "Compensation Start",
                        },
                        { code: "(start:multiple)", desc: "Multiple Start" },
                        { code: "(start:parallel)", desc: "Parallel Multiple" },
                    ],
                    "Intermediate Catch": [
                        { code: "(timer)", desc: "Timer (shorthand)" },
                        { code: "(catch:message)", desc: "Message Catch" },
                        { code: "(catch:timer)", desc: "Timer Catch" },
                        { code: "(catch:signal)", desc: "Signal Catch" },
                        {
                            code: "(catch:conditional)",
                            desc: "Conditional Catch",
                        },
                        { code: "(catch:link)", desc: "Link Catch" },
                        { code: "(catch:multiple)", desc: "Multiple Catch" },
                        { code: "(catch:parallel)", desc: "Parallel Multiple" },
                    ],
                    "Intermediate Throw": [
                        { code: "(throw)", desc: "None Throw" },
                        { code: "(throw:message)", desc: "Message Throw" },
                        { code: "(throw:signal)", desc: "Signal Throw" },
                        {
                            code: "(throw:escalation)",
                            desc: "Escalation Throw",
                        },
                        {
                            code: "(throw:compensation)",
                            desc: "Compensation Throw",
                        },
                        { code: "(throw:link)", desc: "Link Throw" },
                    ],
                    "End Events": [
                        { code: "(end)", desc: "None End" },
                        { code: "(error)", desc: "Error End" },
                        { code: "(terminate)", desc: "Terminate End" },
                        { code: "(end:message)", desc: "Message End" },
                        { code: "(end:signal)", desc: "Signal End" },
                        { code: "(end:escalation)", desc: "Escalation End" },
                        { code: "(end:cancel)", desc: "Cancel End" },
                        {
                            code: "(end:compensation)",
                            desc: "Compensation End",
                        },
                    ],
                    "Boundary Events": [
                        {
                            code: "(boundary:timer @TaskId)",
                            desc: "Timer Boundary",
                        },
                        {
                            code: "(boundary:message @TaskId)",
                            desc: "Message Boundary",
                        },
                        {
                            code: "(boundary:error @TaskId)",
                            desc: "Error Boundary",
                        },
                        {
                            code: "(boundary:signal @TaskId)",
                            desc: "Signal Boundary",
                        },
                        {
                            code: "(boundary:escalation @TaskId)",
                            desc: "Escalation Boundary",
                        },
                        {
                            code: "(boundary!:timer @TaskId)",
                            desc: "Non-interrupting Timer",
                        },
                    ],
                },
                activities: {
                    "Task Types": [
                        { code: "[Task Name]", desc: "Abstract Task" },
                        { code: "[user: Name]", desc: "User Task" },
                        { code: "[service: Name]", desc: "Service Task" },
                        { code: "[script: Name]", desc: "Script Task" },
                        { code: "[rule: Name]", desc: "Business Rule Task" },
                        { code: "[send: Name]", desc: "Send Task" },
                        { code: "[receive: Name]", desc: "Receive Task" },
                        { code: "[manual: Name]", desc: "Manual Task" },
                    ],
                    "Sub-Processes": [
                        {
                            code: "[[sub: Name]]",
                            desc: "Collapsed Sub-Process",
                        },
                        {
                            code: "[[event-sub: Name]]",
                            desc: "Event Sub-Process",
                        },
                        { code: "[[transaction: Name]]", desc: "Transaction" },
                        { code: "[[adhoc: Name]]", desc: "Ad-Hoc Sub-Process" },
                        { code: "[call: Name]", desc: "Call Activity" },
                    ],
                    "Task Markers": [
                        { code: "[user: Name ~loop]", desc: "With Loop" },
                        {
                            code: "[service: Name ~parallel]",
                            desc: "Parallel Multi-Instance",
                        },
                        {
                            code: "[task: Name ~sequential]",
                            desc: "Sequential Multi-Instance",
                        },
                        {
                            code: "[task: Name ~compensation]",
                            desc: "Compensation Activity",
                        },
                    ],
                },
                gateways: {
                    "Gateway Types": [
                        { code: "<Decision?>", desc: "Exclusive (XOR)" },
                        { code: "<x Decision?>", desc: "Exclusive (explicit)" },
                        { code: "<+ Split>", desc: "Parallel (AND)" },
                        { code: "<o Choice>", desc: "Inclusive (OR)" },
                        { code: "<* Complex>", desc: "Complex Gateway" },
                        { code: "<@ EventGW>", desc: "Event-Based Gateway" },
                        {
                            code: "<@+ Instantiate>",
                            desc: "Event-Based (Instantiating)",
                        },
                    ],
                    Connections: [
                        { code: "[A] -> [B]", desc: "Sequence Flow" },
                        { code: "[A] |Yes| -> [B]", desc: "Labeled Flow" },
                        { code: "[A] |default| -> [B]", desc: "Default Flow" },
                        { code: "[A] ~~> [B]", desc: "Message Flow" },
                        { code: "[A] --> [B]", desc: "Association" },
                    ],
                },
                data: {
                    "Data Objects": [
                        { code: "{data: Name}", desc: "Data Object" },
                        { code: "{input: Name}", desc: "Data Input" },
                        { code: "{output: Name}", desc: "Data Output" },
                        { code: "{store: Name}", desc: "Data Store" },
                        { code: "{collection: Name}", desc: "Data Collection" },
                    ],
                    Artifacts: [
                        { code: "// Comment text", desc: "Text Annotation" },
                        { code: "(( Group Name ))", desc: "Group" },
                    ],
                },
                pools: {
                    "Pools & Lanes": [
                        {
                            code: 'pool "Name" { ... }',
                            desc: "Pool (Participant)",
                        },
                        { code: 'lane "Name" { ... }', desc: "Lane" },
                        {
                            code: 'pool "Name" collapsed',
                            desc: "Collapsed Pool (Black Box)",
                        },
                    ],
                    "Message Flows": [
                        {
                            code: "Pool1.Task ~~> Pool2.Task",
                            desc: "Cross-pool Message",
                        },
                    ],
                },
            };

            // ============================================================
            // EXAMPLES / TEMPLATES
            // ============================================================
            const EXAMPLES = {
                // Test/Debug
                flowtest: `// === FLOW TYPES TEST ===

// 1. Basic Sequence Flow
(start) -> [A] -> [B] -> [C]

// 2. Labeled Flows
[C] |Yes| -> [D]
[C] |No| -> [E]

// 3. Message Flow (dashed arrow)
[D] ~~> [F]

// 4. Association (dotted line)
[E] --> [G]

// 5. Gateway with Default Flow
[F] -> <Check?>
[G] -> <Check?>
<Check?> -> |Pass| (end)
<Check?> |default| -> [Retry] -> [A]`,

                // Getting Started
                simple: `// Simple Order Process
(start) -> [Receive Order] -> <In Stock?>
<In Stock?> -> |Yes| [Pack Items] -> [Ship Order] -> (end)
<In Stock?> -> |No| [Reorder Stock] -> (timer) -> [Pack Items]`,

                gateways: `// Gateway Types Demo
(start) -> <Exclusive?>
<Exclusive?> -> |Path A| [Task A] -> <+ Parallel Split>
<Exclusive?> -> |Path B| [Task B] -> <+ Parallel Split>
<+ Parallel Split> -> [Parallel 1]
<+ Parallel Split> -> [Parallel 2]
[Parallel 1] -> <+ Parallel Join>
[Parallel 2] -> <+ Parallel Join>
<+ Parallel Join> -> <o Inclusive?>
<o Inclusive?> -> |Option 1| [Option Task 1] -> <o Inclusive Join>
<o Inclusive?> -> |Option 2| [Option Task 2] -> <o Inclusive Join>
<o Inclusive Join> -> <@ Event Gateway>
<@ Event Gateway> -> (catch:message) -> [Handle Message] -> (end)
<@ Event Gateway> -> (timer) -> [Handle Timeout] -> (end)`,

                events: `// Event Types Demo
(start:message) -> [user: Process Request]
[user: Process Request] -> (timer) -> [Check Status]
[Check Status] -> <Result?>
<Result?> -> |Success| (throw:signal) -> [Notify Success] -> (end)
<Result?> -> |Warning| (throw:escalation) -> [Handle Escalation] -> (end:escalation)
<Result?> -> |Failure| [Log Error] -> (error)`,

                tasks: `// Task Types Demo
(start) -> [user: Review Request]
[user: Review Request] -> [service: Validate Data]
[service: Validate Data] -> [script: Transform]
[script: Transform] -> [rule: Apply Rules]
[rule: Apply Rules] -> [send: Send Notification]
[send: Send Notification] -> [receive: Wait Response]
[receive: Wait Response] -> [manual: Physical Check]
[manual: Physical Check] -> (end)`,

                // Enterprise Patterns
                approval: `// Multi-Level Approval Workflow
(start) -> [user: Submit Request] -> [service: Validate Request]
[service: Validate Request] -> <Valid?>
<Valid?> -> |No| [user: Fix Issues] -> [service: Validate Request]
<Valid?> -> |Yes| <Amount Check>
<Amount Check> -> |< $1000| [user: Manager Approval] -> <Manager Decision>
<Amount Check> -> |$1000-$10000| [user: Director Approval] -> <Director Decision>
<Amount Check> -> |> $10000| [user: VP Approval] -> <VP Decision>
<Manager Decision> -> |Approved| [service: Process Request] -> (end)
<Manager Decision> -> |Rejected| [send: Notify Rejection] -> (end)
<Director Decision> -> |Approved| [service: Process Request]
<Director Decision> -> |Rejected| [send: Notify Rejection]
<VP Decision> -> |Approved| [user: Finance Review] -> <Finance OK?>
<VP Decision> -> |Rejected| [send: Notify Rejection]
<Finance OK?> -> |Yes| [service: Process Request]
<Finance OK?> -> |No| [send: Notify Rejection]`,

                exception: `// Exception Handling Pattern
(start) -> [service: Start Transaction]
[service: Start Transaction] -> <+ Parallel>
<+ Parallel> -> [service: Update Inventory ~parallel]
<+ Parallel> -> [service: Process Payment ~parallel]
<+ Parallel> -> [service: Create Shipment ~parallel]
[service: Update Inventory ~parallel] -> <+ Join>
[service: Process Payment ~parallel] -> <+ Join>
[service: Create Shipment ~parallel] -> <+ Join>
<+ Join> -> [service: Commit Transaction] -> (end)

// Error Boundary (separate flow)
(start:error) -> [service: Rollback Transaction]
[service: Rollback Transaction] -> [send: Notify Admin]
[send: Notify Admin] -> [script: Log Error Details]
[script: Log Error Details] -> (error)`,

                escalation: `// Escalation Process
(start:message) -> [user: L1 Support Review]
[user: L1 Support Review] -> <Resolved at L1?>
<Resolved at L1?> -> |Yes| [service: Close Ticket] -> (end)
<Resolved at L1?> -> |No| (throw:escalation) -> [user: L2 Support Review]
[user: L2 Support Review] -> <Resolved at L2?>
<Resolved at L2?> -> |Yes| [service: Close Ticket]
<Resolved at L2?> -> |No| (throw:escalation) -> [user: L3 Expert Review]
[user: L3 Expert Review] -> <Resolved at L3?>
<Resolved at L3?> -> |Yes| [service: Close Ticket]
<Resolved at L3?> -> |No| [user: Escalate to Vendor] -> [receive: Wait Vendor Response]
[receive: Wait Vendor Response] -> [service: Apply Solution] -> [service: Close Ticket]`,

                compensation: `// Compensation Pattern (Saga)
(start) -> [service: Reserve Inventory]
[service: Reserve Inventory] -> [service: Charge Payment]
[service: Charge Payment] -> <Payment OK?>
<Payment OK?> -> |Yes| [service: Confirm Shipment] -> <Shipment OK?>
<Payment OK?> -> |No| [service: Release Inventory] -> (error)
<Shipment OK?> -> |Yes| [send: Confirm Order] -> (end)
<Shipment OK?> -> |No| [service: Refund Payment] -> [service: Release Inventory] -> (error)`,

                retry: `// Retry Pattern with Backoff
(start) -> [service: Call External API]
[service: Call External API] -> <API Success?>
<API Success?> -> |Yes| [script: Process Response] -> (end)
<API Success?> -> |No| <Retry Count < 3?>
<Retry Count < 3?> -> |Yes| (timer) -> [script: Increment Counter] -> [service: Call External API]
<Retry Count < 3?> -> |No| [service: Log Failure] -> [send: Alert Operations] -> (error)`,

                // Industry Templates
                onboarding: `// Employee Onboarding Process
(start:message) -> [user: HR Receives Offer Acceptance]
[user: HR Receives Offer Acceptance] -> <+ Parallel Initiate>
<+ Parallel Initiate> -> [user: IT Setup Account ~parallel]
<+ Parallel Initiate> -> [user: Facilities Prep Workspace ~parallel]
<+ Parallel Initiate> -> [user: HR Prepare Documents ~parallel]
<+ Parallel Initiate> -> [send: Welcome Email ~parallel]
[user: IT Setup Account ~parallel] -> <+ Join Prep>
[user: Facilities Prep Workspace ~parallel] -> <+ Join Prep>
[user: HR Prepare Documents ~parallel] -> <+ Join Prep>
[send: Welcome Email ~parallel] -> <+ Join Prep>
<+ Join Prep> -> [user: First Day Orientation]
[user: First Day Orientation] -> [user: Team Introduction]
[user: Team Introduction] -> [user: Initial Training]
[user: Initial Training] -> (timer) -> [user: 30-Day Check-in]
[user: 30-Day Check-in] -> <Probation OK?>
<Probation OK?> -> |Yes| [service: Confirm Employment] -> (end)
<Probation OK?> -> |No| [user: Performance Improvement Plan] -> (timer) -> [user: 60-Day Review] -> <Improved?>
<Improved?> -> |Yes| [service: Confirm Employment]
<Improved?> -> |No| [user: Exit Process] -> (terminate)`,

                invoice: `// Invoice Processing (AP Automation)
(start:message) -> [service: OCR Extract Data]
[service: OCR Extract Data] -> [rule: Validate Invoice Data]
[rule: Validate Invoice Data] -> <Data Valid?>
<Data Valid?> -> |No| [user: Manual Data Entry] -> [rule: Validate Invoice Data]
<Data Valid?> -> |Yes| [service: Match PO]
[service: Match PO] -> <PO Match?>
<PO Match?> -> |2-Way Match| [service: Auto-Approve] -> [service: Schedule Payment] -> (end)
<PO Match?> -> |3-Way Match| [service: Match GRN] -> <GRN Match?>
<PO Match?> -> |No Match| [user: Manual Review] -> <Approve?>
<GRN Match?> -> |Yes| [service: Auto-Approve] -> [service: Schedule Payment]
<GRN Match?> -> |No| [user: Manual Review]
<Approve?> -> |Yes| [service: Schedule Payment]
<Approve?> -> |No| [send: Notify Vendor] -> (end)`,

                incident: `// ITIL Incident Management
(start:message) -> [user: Log Incident]
[user: Log Incident] -> [rule: Categorize & Prioritize]
[rule: Categorize & Prioritize] -> <Priority?>
<Priority?> -> |P1 Critical| [send: Page On-Call] -> [user: Immediate Response]
<Priority?> -> |P2 High| [user: Assign to Team Lead]
<Priority?> -> |P3 Medium| [user: Assign to Queue]
<Priority?> -> |P4 Low| [user: Assign to Queue]
[user: Immediate Response] -> [user: Investigate & Diagnose] -> <Known Error?>
[user: Assign to Team Lead] -> [user: Investigate & Diagnose]
[user: Assign to Queue] -> [user: Investigate & Diagnose]
<Known Error?> -> |Yes| [service: Apply Known Fix] -> [user: Verify Resolution]
<Known Error?> -> |No| [user: Develop Solution] -> [user: Verify Resolution]
[user: Verify Resolution] -> <Resolved?>
<Resolved?> -> |Yes| [service: Update CMDB] -> [user: Close Incident] -> (end)
<Resolved?> -> |No| [user: Investigate & Diagnose]`,

                change: `// ITIL Change Management
(start) -> [user: Submit RFC]
[user: Submit RFC] -> [user: CAB Initial Review]
[user: CAB Initial Review] -> <Change Type?>
<Change Type?> -> |Standard| [service: Auto-Approve] -> [user: Schedule Implementation]
<Change Type?> -> |Normal| [user: Technical Assessment] -> [user: Risk Assessment] -> [user: CAB Review]
<Change Type?> -> |Emergency| [user: ECAB Review] -> <ECAB Approved?>
[user: CAB Review] -> <CAB Approved?>
<CAB Approved?> -> |Yes| [user: Schedule Implementation]
<CAB Approved?> -> |No| [send: Notify Requester] -> (end)
<ECAB Approved?> -> |Yes| [user: Immediate Implementation]
<ECAB Approved?> -> |No| [send: Notify Requester]
[user: Schedule Implementation] -> [user: Implement Change] -> [user: Post-Implementation Review]
[user: Immediate Implementation] -> [user: Post-Implementation Review]
[user: Post-Implementation Review] -> <Success?>
<Success?> -> |Yes| [service: Update CMDB] -> [user: Close RFC] -> (end)
<Success?> -> |No| [user: Rollback Change] -> [user: Root Cause Analysis] -> [user: Close RFC]`,

                kyc: `// KYC (Know Your Customer) Verification
(start:message) -> [service: Receive Application]
[service: Receive Application] -> <+ Parallel Checks>
<+ Parallel Checks> -> [service: ID Verification ~parallel]
<+ Parallel Checks> -> [service: Address Verification ~parallel]
<+ Parallel Checks> -> [service: Sanctions Check ~parallel]
<+ Parallel Checks> -> [service: PEP Check ~parallel]
[service: ID Verification ~parallel] -> <+ Join Checks>
[service: Address Verification ~parallel] -> <+ Join Checks>
[service: Sanctions Check ~parallel] -> <+ Join Checks>
[service: PEP Check ~parallel] -> <+ Join Checks>
<+ Join Checks> -> [rule: Risk Scoring]
[rule: Risk Scoring] -> <Risk Level?>
<Risk Level?> -> |Low| [service: Auto-Approve] -> [send: Welcome Customer] -> (end)
<Risk Level?> -> |Medium| [user: Analyst Review] -> <Analyst Decision?>
<Risk Level?> -> |High| [user: Senior Analyst Review] -> <Senior Decision?>
<Analyst Decision?> -> |Approve| [service: Approve Account] -> [send: Welcome Customer]
<Analyst Decision?> -> |Reject| [send: Rejection Notice] -> (end)
<Analyst Decision?> -> |Escalate| [user: Senior Analyst Review]
<Senior Decision?> -> |Approve| [service: Approve Account] -> [send: Welcome Customer]
<Senior Decision?> -> |Reject| [send: Rejection Notice]`,

                // Advanced
                pools: `// Multi-Pool Collaboration
pool "Customer" {
  (start) -> [Submit Order] -> [Wait for Confirmation] -> (end)
}

pool "Sales" {
  (start:message) -> [user: Process Order] -> <Approved?>
  <Approved?> -> |Yes| [send: Confirm Order] -> (end)
  <Approved?> -> |No| [send: Reject Order] -> (end)
}

pool "Warehouse" {
  (start:message) -> [Pick Items] -> [Pack Shipment] -> [send: Ship Order] -> (end)
}`,

                subprocess: `// Sub-Process Patterns
(start) -> [Receive Order]
[Receive Order] -> [[sub: Validate Order]]
[[sub: Validate Order]] -> <Valid?>
<Valid?> -> |Yes| [[sub: Process Payment]]
<Valid?> -> |No| [Reject Order] -> (end)
[[sub: Process Payment]] -> [[transaction: Fulfill Order]]
[[transaction: Fulfill Order]] -> [send: Confirm Order] -> (end)

// Transaction can be rolled back on error
// Sub-processes encapsulate complex logic`,

                complete: `// Complete BPMN 2.0 Demo
(start:message) -> [user: Receive Request]
[user: Receive Request] -> <+ Parallel>
<+ Parallel> -> [service: Validate ~parallel] -> <Valid?>
<+ Parallel> -> [script: Log Request]
<Valid?> -> |Yes| [rule: Apply Policy] -> <o Options>
<Valid?> -> |No| (throw:escalation) -> [Handle Error] -> (error)
<o Options> -> |Full| [send: Full Notification] -> <o Merge>
<o Options> -> |Partial| [send: Partial Notification] -> <o Merge>
<o Merge> -> <+ Join>
[script: Log Request] -> <+ Join>
<+ Join> -> [receive: Wait Confirmation]
[receive: Wait Confirmation] -> [manual: Final Review]
[manual: Final Review] -> <@ Event Decision>
<@ Event Decision> -> (catch:message) -> [Process Response] -> (end)
<@ Event Decision> -> (timer) -> [Handle Timeout] -> (terminate)`,
            };

            // ============================================================
            // INITIALIZATION
            // ============================================================
            const STORAGE_KEY = "bpmn-editor-autosave";
            let lastParsedElements = new Map();

            document.addEventListener("DOMContentLoaded", () => {
                initTheme();
                initResizer();
                initViewer();
                initSearch();
                renderReference();

                // Restore from auto-save or load default
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    document.getElementById("codeEditor").value = saved;
                    showToast("Restored from auto-save");
                } else {
                    document.getElementById("codeEditor").value =
                        EXAMPLES.simple;
                }
                render();

                document
                    .getElementById("codeEditor")
                    .addEventListener("input", () => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            render();
                            autoSave();
                        }, 400);
                    });

                // Close dropdowns on outside click
                document.addEventListener("click", (e) => {
                    if (!e.target.closest(".dropdown")) {
                        document
                            .querySelectorAll(".dropdown-menu")
                            .forEach((m) => m.classList.remove("open"));
                    }
                    if (!e.target.closest(".search-container")) {
                        document
                            .getElementById("searchResults")
                            .classList.remove("open");
                    }
                });
            });

            function initViewer() {
                bpmnViewer = new BpmnJS({
                    container: "#bpmn-canvas",
                });

                // Update zoom display when user scrolls to zoom
                const container = document.getElementById("bpmn-canvas");
                container.addEventListener("wheel", () => {
                    // Debounce the zoom display update
                    setTimeout(updateZoomDisplay, 50);
                });

                // Listen for subprocess drill-down events
                const eventBus = bpmnViewer.get("eventBus");

                // Track when root element changes (drill into/out of subprocess)
                eventBus.on("root.set", function (event) {
                    const newRoot = event.element;
                    handleRootChange(newRoot);
                });

                // Also listen for double-click on subprocesses to track navigation
                eventBus.on("element.dblclick", function (event) {
                    const element = event.element;
                    if (
                        element.type === "bpmn:SubProcess" ||
                        element.type === "bpmn:Transaction" ||
                        element.type === "bpmn:AdHocSubProcess"
                    ) {
                        // This will be followed by a root.set event
                        // We pre-emptively add to stack here
                    }
                });
            }

            // ============================================================
            // SUBPROCESS NAVIGATION
            // ============================================================
            function handleRootChange(newRoot) {
                if (!newRoot) return;

                const canvas = bpmnViewer.get("canvas");
                const rootElement = canvas.getRootElement();

                // Check if we're at the process level (top) or inside a subprocess
                const isProcessRoot =
                    rootElement.type === "bpmn:Process" ||
                    rootElement.type === "bpmn:Collaboration" ||
                    rootElement.businessObject?.$type === "bpmn:Process";

                if (isProcessRoot) {
                    // We're back at the root - clear the stack
                    navigationStack = [];
                    currentRootElement = rootElement;
                    updateBreadcrumb();
                } else {
                    // We drilled into a subprocess
                    const subprocessName =
                        rootElement.businessObject?.name || "Sub-Process";

                    // Add to navigation stack if not already there
                    const existingIndex = navigationStack.findIndex(
                        (item) => item.id === rootElement.id,
                    );
                    if (existingIndex === -1) {
                        navigationStack.push({
                            id: rootElement.id,
                            name: subprocessName,
                            element: rootElement,
                        });
                    } else {
                        // Navigating back - trim stack to this point
                        navigationStack = navigationStack.slice(
                            0,
                            existingIndex + 1,
                        );
                    }

                    currentRootElement = rootElement;
                    updateBreadcrumb();
                }
            }

            function updateBreadcrumb() {
                const breadcrumbBar = document.getElementById("breadcrumbBar");
                const breadcrumbPath =
                    document.getElementById("breadcrumbPath");

                if (navigationStack.length === 0) {
                    // At root level - hide breadcrumb
                    breadcrumbBar.style.display = "none";
                    return;
                }

                // Show breadcrumb
                breadcrumbBar.style.display = "flex";

                // Build breadcrumb HTML
                let html =
                    '<div class="breadcrumb-item"><button onclick="navigateToRoot()">Process</button></div>';

                navigationStack.forEach((item, index) => {
                    const isLast = index === navigationStack.length - 1;
                    html += '<span class="breadcrumb-separator">›</span>';
                    html += `<div class="breadcrumb-item${isLast ? " current" : ""}">`;
                    html += `<button onclick="navigateToLevel(${index})">${escapeHtml(item.name)}</button>`;
                    html += "</div>";
                });

                html += '<span class="breadcrumb-hint">ESC to go back</span>';

                breadcrumbPath.innerHTML = html;
            }

            function navigateToParent() {
                if (navigationStack.length === 0) return;

                const canvas = bpmnViewer.get("canvas");

                if (navigationStack.length === 1) {
                    // Go back to root
                    navigateToRoot();
                } else {
                    // Go back one level
                    const parentIndex = navigationStack.length - 2;
                    const parent = navigationStack[parentIndex];

                    // Use canvas drill-up
                    try {
                        canvas.setRootElement(
                            canvas.findRoot(parent.id) ||
                                canvas.getRootElements()[0],
                        );
                    } catch (e) {
                        // Fallback: try to get parent from the model
                        navigateToRoot();
                    }
                }
            }

            function navigateToRoot() {
                if (!bpmnViewer) return;

                try {
                    const canvas = bpmnViewer.get("canvas");
                    const rootElements = canvas.getRootElements();

                    // Find the main process/collaboration root
                    const mainRoot =
                        rootElements.find(
                            (el) =>
                                el.type === "bpmn:Process" ||
                                el.type === "bpmn:Collaboration",
                        ) || rootElements[0];

                    if (mainRoot) {
                        canvas.setRootElement(mainRoot);
                    }

                    navigationStack = [];
                    updateBreadcrumb();
                } catch (e) {
                    console.error("Navigation error:", e);
                    showToast("Could not navigate to root");
                }
            }

            function navigateToLevel(index) {
                if (index < 0 || index >= navigationStack.length) return;

                if (index === navigationStack.length - 1) {
                    // Already at this level
                    return;
                }

                const target = navigationStack[index];

                try {
                    const canvas = bpmnViewer.get("canvas");
                    const elementRegistry = bpmnViewer.get("elementRegistry");

                    const targetElement = elementRegistry.get(target.id);
                    if (targetElement) {
                        canvas.setRootElement(targetElement);
                    }

                    // Trim stack
                    navigationStack = navigationStack.slice(0, index + 1);
                    updateBreadcrumb();
                } catch (e) {
                    console.error("Navigation error:", e);
                }
            }

            // ============================================================
            // THEME
            // ============================================================
            function initTheme() {
                const saved = localStorage.getItem("bpmn-theme");
                if (saved === "gentle") {
                    document.documentElement.setAttribute(
                        "data-theme",
                        "gentle",
                    );
                }
            }

            function toggleTheme() {
                const isGentle =
                    document.documentElement.getAttribute("data-theme") ===
                    "gentle";
                document.documentElement.setAttribute(
                    "data-theme",
                    isGentle ? "" : "gentle",
                );
                localStorage.setItem(
                    "bpmn-theme",
                    isGentle ? "light" : "gentle",
                );
            }

            // ============================================================
            // REFERENCE PANEL
            // ============================================================
            function renderReference() {
                const content = document.getElementById("referenceContent");
                const data = REFERENCE_DATA[currentRefTab];

                let html = "";
                for (const [section, items] of Object.entries(data)) {
                    html += `<div class="ref-section">
                    <div class="ref-section-title">${section}</div>
                    <div class="ref-grid">
                        ${items
                            .map(
                                (item) => `
                            <div class="ref-item" onclick="insertCode('${escapeHtml(item.code)}')">
                                <code>${escapeHtml(item.code)}</code>
                                <span>${item.desc}</span>
                            </div>
                        `,
                            )
                            .join("")}
                    </div>
                </div>`;
                }
                content.innerHTML = html;
            }

            function setRefTab(tab) {
                currentRefTab = tab;
                document
                    .querySelectorAll(".reference-tab")
                    .forEach((t) => t.classList.remove("active"));
                event.target.classList.add("active");
                renderReference();
            }

            function insertCode(code) {
                const editor = document.getElementById("codeEditor");
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const value = editor.value;

                editor.value =
                    value.substring(0, start) + code + value.substring(end);
                editor.selectionStart = editor.selectionEnd =
                    start + code.length;
                editor.focus();

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(render, 400);

                showToast("Inserted: " + code);
            }

            // ============================================================
            // DSL PARSER
            // ============================================================
            function parseDSL(code) {
                const elements = new Map();
                const flows = [];
                const pools = [];
                const lanes = [];
                const boundaryEvents = [];
                let elementId = 0;

                // Split into lines, filter empty and pure comments
                const lines = code
                    .split("\n")
                    .map((l) => l.trim())
                    .filter((l) => l && !l.startsWith("//"));

                // Parse each line
                lines.forEach((line) => {
                    // Skip pool/lane definitions for now (simplified)
                    if (
                        line.startsWith("pool ") ||
                        line.startsWith("lane ") ||
                        line === "{" ||
                        line === "}"
                    ) {
                        return;
                    }

                    // Tokenize line into elements and connectors
                    // Connectors: -> (sequence), ~~> (message), --> (association)
                    const tokens = tokenizeLine(line);

                    let lastElement = null;
                    let pendingLabel = null;
                    let pendingFlowType = "sequence";

                    for (const token of tokens) {
                        if (token.type === "connector") {
                            pendingFlowType = token.flowType;
                        } else if (token.type === "label") {
                            pendingLabel = token.value;
                        } else if (token.type === "element") {
                            const elementKey = token.value;

                            // Parse and register element if new
                            if (!elements.has(elementKey)) {
                                elementId++;
                                const parsed = parseElement(
                                    elementKey,
                                    elementId,
                                );
                                elements.set(elementKey, parsed);
                            }

                            // Create flow from last element to this one
                            if (lastElement) {
                                const source = elements.get(lastElement);
                                const target = elements.get(elementKey);

                                if (source && target) {
                                    flows.push({
                                        id: `Flow_${flows.length + 1}`,
                                        sourceRef: source.id,
                                        targetRef: target.id,
                                        sourceKey: lastElement,
                                        targetKey: elementKey,
                                        name: pendingLabel || "",
                                        isDefault: pendingLabel === "default",
                                        flowType: pendingFlowType,
                                    });
                                }
                            }

                            lastElement = elementKey;
                            pendingLabel = null;
                            pendingFlowType = "sequence";
                        }
                    }
                });

                return { elements, flows, pools, lanes, boundaryEvents };
            }

            // Tokenize a line into elements, connectors, and labels
            function tokenizeLine(line) {
                const tokens = [];
                let remaining = line;

                while (remaining.length > 0) {
                    remaining = remaining.trim();
                    if (!remaining) break;

                    // Check for connectors first (order matters: longer patterns first)
                    if (remaining.startsWith("~~>")) {
                        tokens.push({ type: "connector", flowType: "message" });
                        remaining = remaining.slice(3);
                        continue;
                    }
                    if (remaining.startsWith("-->")) {
                        tokens.push({
                            type: "connector",
                            flowType: "association",
                        });
                        remaining = remaining.slice(3);
                        continue;
                    }
                    if (
                        remaining.startsWith("->") ||
                        remaining.startsWith("→")
                    ) {
                        tokens.push({
                            type: "connector",
                            flowType: "sequence",
                        });
                        remaining = remaining.slice(
                            remaining.startsWith("→") ? 1 : 2,
                        );
                        continue;
                    }

                    // Check for label |...|
                    const labelMatch = remaining.match(/^\|([^|]+)\|/);
                    if (labelMatch) {
                        tokens.push({ type: "label", value: labelMatch[1] });
                        remaining = remaining.slice(labelMatch[0].length);
                        continue;
                    }

                    // Parse bracketed elements: [...], (...), <...>, {...}
                    // These are the BPMN element delimiters
                    const bracketMatch = remaining.match(
                        /^(\[[^\]]*\]|\([^)]*\)|<[^>]*>|\{[^}]*\})/,
                    );
                    if (bracketMatch) {
                        tokens.push({
                            type: "element",
                            value: bracketMatch[1],
                        });
                        remaining = remaining.slice(bracketMatch[1].length);
                        continue;
                    }

                    // Check for unbracketed text (like pool references: PoolName.TaskName)
                    // Stop at whitespace, connectors, labels, or brackets
                    const textMatch = remaining.match(/^([^\s\[\]()<>{}\|]+)/);
                    if (textMatch) {
                        // This might be a pool.element reference or just noise - skip it for now
                        // In a more complete implementation, this would handle pool references
                        remaining = remaining.slice(textMatch[1].length);
                        continue;
                    }

                    // Fallback: skip one character
                    remaining = remaining.slice(1);
                }

                return tokens;
            }

            function parseElement(part, id) {
                const elementId = `Element_${id}`;

                // Check events
                const lowerPart = part.toLowerCase();
                for (const [pattern, config] of Object.entries(ALL_EVENTS)) {
                    if (lowerPart === pattern) {
                        return {
                            id: elementId,
                            key: part,
                            type: config.type,
                            trigger: config.trigger,
                            name: "",
                            width: 36,
                            height: 36,
                        };
                    }
                }

                // Check gateways
                if (part.startsWith("<") && part.endsWith(">")) {
                    const content = part.slice(1, -1);
                    let gwType = "exclusiveGateway";
                    let name = content;

                    // Check gateway prefixes
                    for (const [prefix, config] of Object.entries(
                        GATEWAY_TYPES,
                    )) {
                        const checkPrefix = prefix.slice(1); // Remove <
                        if (
                            content.startsWith(checkPrefix) &&
                            checkPrefix !== ""
                        ) {
                            gwType = config.type;
                            name = content.slice(checkPrefix.length).trim();
                            break;
                        }
                    }

                    return {
                        id: elementId,
                        key: part,
                        type: gwType,
                        name: name,
                        width: 50,
                        height: 50,
                    };
                }

                // Check sub-processes [[...]]
                if (part.startsWith("[[") && part.endsWith("]]")) {
                    const content = part.slice(2, -2).trim();
                    let subType = "subProcess";
                    let name = content;

                    for (const [prefix, config] of Object.entries(
                        SUBPROCESS_TYPES,
                    )) {
                        if (content.toLowerCase().startsWith(prefix)) {
                            subType = config.type;
                            name = content.slice(prefix.length).trim();
                            break;
                        }
                    }

                    return {
                        id: elementId,
                        key: part,
                        type: subType,
                        name: name,
                        width: 120,
                        height: 80,
                    };
                }

                // Check tasks [...]
                if (part.startsWith("[") && part.endsWith("]")) {
                    const content = part.slice(1, -1).trim();
                    let taskType = "task";
                    let name = content;
                    let marker = null;

                    // Check for markers
                    for (const [markerSuffix, markerConfig] of Object.entries(
                        TASK_MARKERS,
                    )) {
                        if (content.endsWith(markerSuffix)) {
                            marker = markerConfig;
                            name = content
                                .slice(0, -markerSuffix.length)
                                .trim();
                            break;
                        }
                    }

                    // Check for call activity (special case - uses single brackets)
                    if (name.toLowerCase().startsWith("call:")) {
                        return {
                            id: elementId,
                            key: part,
                            type: "callActivity",
                            name: name.slice(5).trim(),
                            marker: marker,
                            width: 100,
                            height: 80,
                        };
                    }

                    // Check for task type prefix
                    for (const [prefix, config] of Object.entries(TASK_TYPES)) {
                        if (prefix && name.toLowerCase().startsWith(prefix)) {
                            taskType = config.type;
                            name = name.slice(prefix.length).trim();
                            break;
                        }
                    }

                    return {
                        id: elementId,
                        key: part,
                        type: taskType,
                        name: name,
                        marker: marker,
                        width: 100,
                        height: 80,
                    };
                }

                // Check data objects
                if (part.startsWith("{") && part.endsWith("}")) {
                    const content = part.slice(1, -1).trim();
                    let dataType = "dataObjectReference";
                    let name = content;

                    for (const [prefix, config] of Object.entries(DATA_TYPES)) {
                        const checkPrefix = prefix.slice(1); // Remove {
                        if (content.toLowerCase().startsWith(checkPrefix)) {
                            dataType = config.type;
                            name = content.slice(checkPrefix.length).trim();
                            break;
                        }
                    }

                    return {
                        id: elementId,
                        key: part,
                        type: dataType,
                        name: name,
                        width: 36,
                        height: 50,
                    };
                }

                // Check text annotations
                if (part.startsWith("//")) {
                    return {
                        id: elementId,
                        key: part,
                        type: "textAnnotation",
                        name: part.slice(2).trim(),
                        width: 100,
                        height: 50,
                    };
                }

                // Default: treat as task
                return {
                    id: elementId,
                    key: part,
                    type: "task",
                    name: part,
                    width: 100,
                    height: 80,
                };
            }

            // ============================================================
            // BPMN XML GENERATOR
            // ============================================================
            function generateBPMNXml(parsed) {
                const { elements, flows } = parsed;

                // Layout with dagre
                const g = new dagre.graphlib.Graph();
                g.setGraph({
                    rankdir: "LR",
                    nodesep: 60,
                    ranksep: 100,
                    marginx: 50,
                    marginy: 50,
                });
                g.setDefaultEdgeLabel(() => ({}));

                elements.forEach((el, key) => {
                    g.setNode(key, {
                        width: el.width,
                        height: el.height,
                        element: el,
                    });
                });

                flows.forEach((flow) => {
                    g.setEdge(flow.sourceKey, flow.targetKey);
                });

                dagre.layout(g);

                // Get positions
                const positions = new Map();
                g.nodes().forEach((key) => {
                    const node = g.node(key);
                    if (node) {
                        positions.set(key, {
                            x: Math.round(node.x - node.width / 2),
                            y: Math.round(node.y - node.height / 2),
                            width: node.width,
                            height: node.height,
                        });
                    }
                });

                // Generate XML
                let processContent = "";
                let shapeContent = "";

                elements.forEach((el, key) => {
                    const pos = positions.get(key) || { x: 100, y: 100 };
                    processContent += generateElementXml(el);
                    shapeContent += generateShapeXml(el, pos);
                });

                let edgeContent = "";
                flows.forEach((flow) => {
                    processContent += generateFlowXml(flow);
                    edgeContent += generateEdgeXml(
                        flow,
                        g,
                        positions,
                        elements,
                    );
                });

                return `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
    xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    id="Definitions_1"
    targetNamespace="http://bpmn.io/schema/bpmn"
    exporter="BPMN 2.0 Editor"
    exporterVersion="1.0">
  <bpmn:process id="Process_1" isExecutable="false">
${processContent}  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
${shapeContent}${edgeContent}    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
            }

            function generateElementXml(el) {
                const name = escapeXml(el.name);
                const trigger = el.trigger ? `<bpmn:${el.trigger}/>` : "";

                // Handle markers
                let markerXml = "";
                if (el.marker) {
                    if (
                        el.marker.loopCharacteristics ===
                        "standardLoopCharacteristics"
                    ) {
                        markerXml = "<bpmn:standardLoopCharacteristics/>";
                    } else if (
                        el.marker.loopCharacteristics ===
                        "multiInstanceLoopCharacteristics"
                    ) {
                        const seq = el.marker.isSequential
                            ? ' isSequential="true"'
                            : "";
                        markerXml = `<bpmn:multiInstanceLoopCharacteristics${seq}/>`;
                    }
                }

                switch (el.type) {
                    case "startEvent":
                        return `    <bpmn:startEvent id="${el.id}" name="${name}">${trigger}</bpmn:startEvent>\n`;
                    case "endEvent":
                        return `    <bpmn:endEvent id="${el.id}" name="${name}">${trigger}</bpmn:endEvent>\n`;
                    case "intermediateCatchEvent":
                        return `    <bpmn:intermediateCatchEvent id="${el.id}" name="${name}">${trigger}</bpmn:intermediateCatchEvent>\n`;
                    case "intermediateThrowEvent":
                        return `    <bpmn:intermediateThrowEvent id="${el.id}" name="${name}">${trigger}</bpmn:intermediateThrowEvent>\n`;
                    case "task":
                        return `    <bpmn:task id="${el.id}" name="${name}">${markerXml}</bpmn:task>\n`;
                    case "userTask":
                        return `    <bpmn:userTask id="${el.id}" name="${name}">${markerXml}</bpmn:userTask>\n`;
                    case "serviceTask":
                        return `    <bpmn:serviceTask id="${el.id}" name="${name}">${markerXml}</bpmn:serviceTask>\n`;
                    case "scriptTask":
                        return `    <bpmn:scriptTask id="${el.id}" name="${name}">${markerXml}</bpmn:scriptTask>\n`;
                    case "businessRuleTask":
                        return `    <bpmn:businessRuleTask id="${el.id}" name="${name}">${markerXml}</bpmn:businessRuleTask>\n`;
                    case "sendTask":
                        return `    <bpmn:sendTask id="${el.id}" name="${name}">${markerXml}</bpmn:sendTask>\n`;
                    case "receiveTask":
                        return `    <bpmn:receiveTask id="${el.id}" name="${name}">${markerXml}</bpmn:receiveTask>\n`;
                    case "manualTask":
                        return `    <bpmn:manualTask id="${el.id}" name="${name}">${markerXml}</bpmn:manualTask>\n`;
                    case "subProcess":
                        return `    <bpmn:subProcess id="${el.id}" name="${name}"/>\n`;
                    case "callActivity":
                        return `    <bpmn:callActivity id="${el.id}" name="${name}"/>\n`;
                    case "transaction":
                        return `    <bpmn:transaction id="${el.id}" name="${name}"/>\n`;
                    case "adHocSubProcess":
                        return `    <bpmn:adHocSubProcess id="${el.id}" name="${name}"/>\n`;
                    case "exclusiveGateway":
                        return `    <bpmn:exclusiveGateway id="${el.id}" name="${name}"/>\n`;
                    case "parallelGateway":
                        return `    <bpmn:parallelGateway id="${el.id}" name="${name}"/>\n`;
                    case "inclusiveGateway":
                        return `    <bpmn:inclusiveGateway id="${el.id}" name="${name}"/>\n`;
                    case "complexGateway":
                        return `    <bpmn:complexGateway id="${el.id}" name="${name}"/>\n`;
                    case "eventBasedGateway":
                        return `    <bpmn:eventBasedGateway id="${el.id}" name="${name}"/>\n`;
                    case "dataObjectReference":
                        return `    <bpmn:dataObjectReference id="${el.id}" name="${name}"/>\n`;
                    case "dataStoreReference":
                        return `    <bpmn:dataStoreReference id="${el.id}" name="${name}"/>\n`;
                    case "textAnnotation":
                        return `    <bpmn:textAnnotation id="${el.id}"><bpmn:text>${name}</bpmn:text></bpmn:textAnnotation>\n`;
                    default:
                        return `    <bpmn:task id="${el.id}" name="${name}"/>\n`;
                }
            }

            function generateShapeXml(el, pos) {
                const isGateway = el.type.includes("Gateway");
                const isEvent = el.type.includes("Event");
                const markerVisible = isGateway
                    ? ' isMarkerVisible="true"'
                    : "";

                let labelXml = "";
                if ((isGateway || isEvent) && el.name) {
                    labelXml = `\n        <bpmndi:BPMNLabel>
          <dc:Bounds x="${pos.x - 10}" y="${pos.y + pos.height + 5}" width="${pos.width + 20}" height="14"/>
        </bpmndi:BPMNLabel>`;
                }

                return `      <bpmndi:BPMNShape id="${el.id}_di" bpmnElement="${el.id}"${markerVisible}>
        <dc:Bounds x="${pos.x}" y="${pos.y}" width="${pos.width}" height="${pos.height}"/>${labelXml}
      </bpmndi:BPMNShape>\n`;
            }

            function generateFlowXml(flow) {
                const name =
                    flow.name && flow.name !== "default"
                        ? ` name="${escapeXml(flow.name)}"`
                        : "";

                switch (flow.flowType) {
                    case "message":
                        // Message flows require pools/collaboration to render properly
                        // Within a single process, render as sequence flow with label
                        const msgLabel = flow.name ? flow.name : "message";
                        return `    <bpmn:sequenceFlow id="${flow.id}" name="${escapeXml(msgLabel)}" sourceRef="${flow.sourceRef}" targetRef="${flow.targetRef}"/>\n`;
                    case "association":
                        // Association (dotted line) - note: may render as sequence flow in some viewers
                        return `    <bpmn:association id="${flow.id}" sourceRef="${flow.sourceRef}" targetRef="${flow.targetRef}" associationDirection="One"/>\n`;
                    default:
                        // Sequence flow
                        return `    <bpmn:sequenceFlow id="${flow.id}"${name} sourceRef="${flow.sourceRef}" targetRef="${flow.targetRef}"/>\n`;
                }
            }

            function generateEdgeXml(flow, g, positions, elements) {
                const sourceEl = elements.get(flow.sourceKey);
                const targetEl = elements.get(flow.targetKey);
                const sp = positions.get(flow.sourceKey);
                const tp = positions.get(flow.targetKey);

                if (!sp || !tp || !sourceEl || !targetEl) {
                    return "";
                }

                // Calculate connection points based on relative positions
                let waypoints = "";

                // Source center
                const srcCenterX = sp.x + sp.width / 2;
                const srcCenterY = sp.y + sp.height / 2;

                // Target center
                const tgtCenterX = tp.x + tp.width / 2;
                const tgtCenterY = tp.y + tp.height / 2;

                // Determine connection sides based on relative position
                const dx = tgtCenterX - srcCenterX;
                const dy = tgtCenterY - srcCenterY;

                // Check if this is a "backwards" flow (target is to the left of source)
                const isBackwardsFlow = dx < -50;

                if (isBackwardsFlow) {
                    // Route backwards flows: go down from source, left, then up to target
                    const srcX = srcCenterX;
                    const srcY = sp.y + sp.height; // Bottom of source
                    const tgtX = tgtCenterX;
                    const tgtY = tp.y + tp.height; // Bottom of target

                    // Go below both elements
                    const routeY = Math.max(srcY, tgtY) + 40;

                    waypoints = `        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(srcY)}"/>
        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(routeY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(routeY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(tgtY)}"/>\n`;
                } else {
                    // Normal left-to-right flow
                    const isHorizontal = Math.abs(dx) > Math.abs(dy);

                    let srcX, srcY, tgtX, tgtY;

                    if (isHorizontal) {
                        if (dx > 0) {
                            // Target is to the right - connect right side to left side
                            srcX = sp.x + sp.width;
                            srcY = srcCenterY;
                            tgtX = tp.x;
                            tgtY = tgtCenterY;
                        } else {
                            // Target is slightly to the left but close - connect left to right
                            srcX = sp.x;
                            srcY = srcCenterY;
                            tgtX = tp.x + tp.width;
                            tgtY = tgtCenterY;
                        }

                        // If there's significant vertical difference, add intermediate waypoints
                        if (Math.abs(dy) > 20) {
                            const midX = (srcX + tgtX) / 2;
                            waypoints = `        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(srcY)}"/>
        <di:waypoint x="${Math.round(midX)}" y="${Math.round(srcY)}"/>
        <di:waypoint x="${Math.round(midX)}" y="${Math.round(tgtY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(tgtY)}"/>\n`;
                        } else {
                            waypoints = `        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(srcY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(tgtY)}"/>\n`;
                        }
                    } else {
                        if (dy > 0) {
                            // Target is below - connect bottom to top
                            srcX = srcCenterX;
                            srcY = sp.y + sp.height;
                            tgtX = tgtCenterX;
                            tgtY = tp.y;
                        } else {
                            // Target is above - connect top to bottom
                            srcX = srcCenterX;
                            srcY = sp.y;
                            tgtX = tgtCenterX;
                            tgtY = tp.y + tp.height;
                        }

                        // If there's significant horizontal difference, add intermediate waypoints
                        if (Math.abs(dx) > 20) {
                            const midY = (srcY + tgtY) / 2;
                            waypoints = `        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(srcY)}"/>
        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(midY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(midY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(tgtY)}"/>\n`;
                        } else {
                            waypoints = `        <di:waypoint x="${Math.round(srcX)}" y="${Math.round(srcY)}"/>
        <di:waypoint x="${Math.round(tgtX)}" y="${Math.round(tgtY)}"/>\n`;
                        }
                    }
                }

                // Label positioning
                let labelXml = "";
                if (flow.name) {
                    const labelX = Math.min(sp.x, tp.x) + Math.abs(dx) / 2;
                    const labelY = Math.min(sp.y, tp.y) - 15;
                    labelXml = `        <bpmndi:BPMNLabel>
          <dc:Bounds x="${Math.round(labelX)}" y="${Math.round(labelY)}" width="50" height="14"/>
        </bpmndi:BPMNLabel>\n`;
                }

                return `      <bpmndi:BPMNEdge id="${flow.id}_di" bpmnElement="${flow.id}">
${waypoints}${labelXml}      </bpmndi:BPMNEdge>\n`;
            }

            // ============================================================
            // RENDER
            // ============================================================
            async function render() {
                const code = document.getElementById("codeEditor").value.trim();
                if (!code) {
                    updateStatus("Empty", true);
                    lastParsedElements = new Map();
                    return;
                }

                try {
                    const parsed = parseDSL(code);
                    const xml = generateBPMNXml(parsed);
                    lastBpmnXml = xml;

                    // Store elements for search
                    lastParsedElements = parsed.elements;

                    // Reset subprocess navigation before loading new diagram
                    navigationStack = [];
                    currentRootElement = null;
                    updateBreadcrumb();

                    await bpmnViewer.importXML(xml);
                    centerDiagram();

                    updateStatus("Ready", false);
                    document.getElementById("elementCount").textContent =
                        `${parsed.elements.size} elements`;
                } catch (err) {
                    console.error("Render error:", err);
                    updateStatus("Error: " + err.message, true);
                    lastBpmnXml = null;
                }
            }

            function centerDiagram() {
                if (!bpmnViewer) return;

                try {
                    const canvas = bpmnViewer.get("canvas");
                    canvas.zoom("fit-viewport");
                    updateZoomDisplay();
                } catch (err) {
                    console.error("Center error:", err);
                    zoomLevel = 1;
                    document.getElementById("zoomLevel").textContent = "100%";
                }
            }

            function updateStatus(text, isError) {
                document.getElementById("statusText").textContent = text;
                document
                    .getElementById("statusDot")
                    .classList.toggle("error", isError);
            }

            // ============================================================
            // ZOOM
            // ============================================================
            function zoomIn() {
                if (!bpmnViewer) return;

                try {
                    const canvas = bpmnViewer.get("canvas");
                    zoomLevel = Math.min(zoomLevel + 0.2, 4);
                    canvas.zoom(zoomLevel);
                    document.getElementById("zoomLevel").textContent =
                        Math.round(zoomLevel * 100) + "%";
                } catch (err) {
                    console.error("Zoom error:", err);
                }
            }

            function zoomOut() {
                if (!bpmnViewer) return;

                try {
                    const canvas = bpmnViewer.get("canvas");
                    zoomLevel = Math.max(zoomLevel - 0.2, 0.2);
                    canvas.zoom(zoomLevel);
                    document.getElementById("zoomLevel").textContent =
                        Math.round(zoomLevel * 100) + "%";
                } catch (err) {
                    console.error("Zoom error:", err);
                }
            }

            function updateZoomDisplay() {
                if (!bpmnViewer) return;
                try {
                    const canvas = bpmnViewer.get("canvas");
                    zoomLevel = canvas.zoom();
                    document.getElementById("zoomLevel").textContent =
                        Math.round(zoomLevel * 100) + "%";
                } catch (err) {}
            }

            function fitView() {
                centerDiagram();
            }

            // ============================================================
            // PAN / NAVIGATION
            // ============================================================
            function panCanvas(deltaX, deltaY) {
                if (!bpmnViewer) return;

                try {
                    const canvas = bpmnViewer.get("canvas");
                    const viewbox = canvas.viewbox();

                    canvas.viewbox({
                        x: viewbox.x - deltaX,
                        y: viewbox.y - deltaY,
                        width: viewbox.width,
                        height: viewbox.height,
                    });
                } catch (err) {
                    console.error("Pan error:", err);
                }
            }

            function resetView() {
                centerDiagram();
            }

            // Keyboard navigation
            document.addEventListener("keydown", (e) => {
                // Only handle if preview panel is focused or no input is focused
                const activeEl = document.activeElement;
                if (
                    activeEl &&
                    (activeEl.tagName === "TEXTAREA" ||
                        activeEl.tagName === "INPUT")
                ) {
                    return;
                }

                const panAmount = e.shiftKey ? 200 : 80;

                switch (e.key) {
                    case "ArrowUp":
                        e.preventDefault();
                        panCanvas(0, -panAmount);
                        break;
                    case "ArrowDown":
                        e.preventDefault();
                        panCanvas(0, panAmount);
                        break;
                    case "ArrowLeft":
                        e.preventDefault();
                        panCanvas(-panAmount, 0);
                        break;
                    case "ArrowRight":
                        e.preventDefault();
                        panCanvas(panAmount, 0);
                        break;
                    case "Home":
                        e.preventDefault();
                        resetView();
                        break;
                    case "Escape":
                        // Navigate back in subprocess hierarchy
                        if (navigationStack.length > 0) {
                            e.preventDefault();
                            navigateToParent();
                        }
                        break;
                    case "+":
                    case "=":
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            zoomIn();
                        }
                        break;
                    case "-":
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            zoomOut();
                        }
                        break;
                }
            });

            // ============================================================
            // EXPORT
            // ============================================================
            function exportBPMN() {
                closeDropdowns();
                if (!lastBpmnXml) {
                    showToast("No diagram to export");
                    return;
                }
                downloadFile(
                    lastBpmnXml,
                    `process-${Date.now()}.bpmn`,
                    "application/xml",
                );
                showToast("BPMN XML exported");
            }

            async function exportSVG() {
                closeDropdowns();
                if (!bpmnViewer) {
                    showToast("No diagram to export");
                    return;
                }
                try {
                    const { svg } = await bpmnViewer.saveSVG();
                    downloadFile(
                        svg,
                        `diagram-${Date.now()}.svg`,
                        "image/svg+xml",
                    );
                    showToast("SVG exported");
                } catch (err) {
                    showToast("Export failed: " + err.message);
                }
            }

            function downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            // ============================================================
            // IMPORT
            // ============================================================
            function importFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result;

                    // Check if it's BPMN XML
                    if (
                        content.trim().startsWith("<?xml") ||
                        content.includes("bpmn:definitions") ||
                        content.includes("definitions")
                    ) {
                        // It's a BPMN XML file - import directly to viewer
                        try {
                            await bpmnViewer.importXML(content);
                            centerDiagram();
                            lastBpmnXml = content;

                            // Convert to DSL (basic representation)
                            const dsl = bpmnXmlToDsl(content);
                            document.getElementById("codeEditor").value =
                                dsl ||
                                "// Imported BPMN diagram\n// (Edit DSL to modify or view rendered diagram)";

                            showToast("BPMN file imported");
                            updateStatus("Ready", false);

                            // Count elements
                            const elementRegistry =
                                bpmnViewer.get("elementRegistry");
                            const count = elementRegistry
                                .getAll()
                                .filter(
                                    (e) =>
                                        e.type !== "bpmn:Process" &&
                                        e.type !== "bpmn:Collaboration",
                                ).length;
                            document.getElementById(
                                "elementCount",
                            ).textContent = count + " elements";
                        } catch (err) {
                            console.error("BPMN import error:", err);
                            showToast("Failed to import BPMN: " + err.message);
                            updateStatus("Import error", true);
                        }
                    } else {
                        // It's a DSL/text file
                        document.getElementById("codeEditor").value = content;
                        render();
                        showToast("DSL file imported");
                    }

                    autoSave();
                };
                reader.readAsText(file);
                event.target.value = "";
            }

            // Basic BPMN XML to DSL converter
            function bpmnXmlToDsl(xml) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xml, "text/xml");

                    const lines = ["// Imported from BPMN XML"];

                    // Find all elements
                    const elements = [];
                    const flows = [];

                    // Extract flow nodes
                    doc.querySelectorAll(
                        "startEvent, endEvent, task, userTask, serviceTask, scriptTask, manualTask, sendTask, receiveTask, businessRuleTask, exclusiveGateway, parallelGateway, inclusiveGateway, eventBasedGateway, intermediateCatchEvent, intermediateThrowEvent, subProcess",
                    ).forEach((el) => {
                        const id = el.getAttribute("id");
                        const name = el.getAttribute("name") || "";
                        const type = el.localName;
                        elements.push({ id, name, type });
                    });

                    // Extract sequence flows
                    doc.querySelectorAll("sequenceFlow").forEach((flow) => {
                        const sourceRef = flow.getAttribute("sourceRef");
                        const targetRef = flow.getAttribute("targetRef");
                        const name = flow.getAttribute("name") || "";
                        flows.push({ sourceRef, targetRef, name });
                    });

                    // Build DSL representation
                    const elementMap = new Map(elements.map((e) => [e.id, e]));

                    flows.forEach((flow) => {
                        const source = elementMap.get(flow.sourceRef);
                        const target = elementMap.get(flow.targetRef);
                        if (source && target) {
                            const srcDsl = elementToDsl(source);
                            const tgtDsl = elementToDsl(target);
                            const condition = flow.name
                                ? ` |${flow.name}|`
                                : "";
                            lines.push(`${srcDsl} ->${condition} ${tgtDsl}`);
                        }
                    });

                    return lines.join("\n");
                } catch (err) {
                    console.error("DSL conversion error:", err);
                    return null;
                }
            }

            function elementToDsl(el) {
                const name = el.name || el.type;
                switch (el.type) {
                    case "startEvent":
                        return "(start)";
                    case "endEvent":
                        return "(end)";
                    case "userTask":
                        return `[user: ${name}]`;
                    case "serviceTask":
                        return `[service: ${name}]`;
                    case "scriptTask":
                        return `[script: ${name}]`;
                    case "manualTask":
                        return `[manual: ${name}]`;
                    case "sendTask":
                        return `[send: ${name}]`;
                    case "receiveTask":
                        return `[receive: ${name}]`;
                    case "businessRuleTask":
                        return `[rule: ${name}]`;
                    case "exclusiveGateway":
                        return `<${name || "Gateway"}?>`;
                    case "parallelGateway":
                        return `<+ ${name || "Parallel"}>`;
                    case "inclusiveGateway":
                        return `<o ${name || "Inclusive"}>`;
                    case "eventBasedGateway":
                        return `<@ ${name || "Event"}>`;
                    case "intermediateCatchEvent":
                        return "(timer)";
                    case "intermediateThrowEvent":
                        return "(throw)";
                    case "subProcess":
                        return `[[sub: ${name}]]`;
                    default:
                        return `[${name}]`;
                }
            }

            // ============================================================
            // AUTO-SAVE
            // ============================================================
            function autoSave() {
                const code = document.getElementById("codeEditor").value;
                const indicator = document.getElementById("autosaveIndicator");
                const text = document.getElementById("autosaveText");

                indicator.classList.add("saving");
                indicator.classList.remove("saved");
                text.textContent = "Saving...";

                try {
                    localStorage.setItem(STORAGE_KEY, code);
                    setTimeout(() => {
                        indicator.classList.remove("saving");
                        indicator.classList.add("saved");
                        text.textContent = "Saved";
                        setTimeout(() => {
                            indicator.classList.remove("saved");
                            text.textContent = "Auto-save enabled";
                        }, 2000);
                    }, 300);
                } catch (err) {
                    text.textContent = "Save failed";
                    console.error("Auto-save error:", err);
                }
            }

            function clearAutoSave() {
                localStorage.removeItem(STORAGE_KEY);
            }

            // ============================================================
            // SEARCH
            // ============================================================
            function initSearch() {
                const input = document.getElementById("searchInput");
                const results = document.getElementById("searchResults");
                let selectedIndex = -1;

                input.addEventListener("input", () => {
                    const query = input.value.trim().toLowerCase();
                    if (query.length < 2) {
                        results.classList.remove("open");
                        return;
                    }

                    const matches = searchElements(query);
                    renderSearchResults(matches);
                    selectedIndex = -1;
                });

                input.addEventListener("keydown", (e) => {
                    const items = results.querySelectorAll(
                        ".search-result-item",
                    );

                    if (e.key === "ArrowDown") {
                        e.preventDefault();
                        selectedIndex = Math.min(
                            selectedIndex + 1,
                            items.length - 1,
                        );
                        updateSearchSelection(items, selectedIndex);
                    } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, 0);
                        updateSearchSelection(items, selectedIndex);
                    } else if (e.key === "Enter" && selectedIndex >= 0) {
                        e.preventDefault();
                        items[selectedIndex].click();
                    } else if (e.key === "Escape") {
                        results.classList.remove("open");
                        input.blur();
                    }
                });

                input.addEventListener("focus", () => {
                    if (input.value.trim().length >= 2) {
                        results.classList.add("open");
                    }
                });
            }

            function searchElements(query) {
                const matches = [];
                const lowerQuery = query.toLowerCase();

                lastParsedElements.forEach((el, key) => {
                    const name = (el.name || "").toLowerCase();
                    const type = (el.type || "").toLowerCase();

                    if (
                        name.includes(lowerQuery) ||
                        type.includes(lowerQuery) ||
                        key.toLowerCase().includes(lowerQuery)
                    ) {
                        matches.push({ key, ...el });
                    }
                });

                return matches.slice(0, 10); // Limit to 10 results
            }

            function renderSearchResults(matches) {
                const results = document.getElementById("searchResults");

                if (matches.length === 0) {
                    results.innerHTML =
                        '<div class="search-no-results">No elements found</div>';
                    results.classList.add("open");
                    return;
                }

                results.innerHTML = matches
                    .map(
                        (m, i) => `
                <div class="search-result-item" data-key="${m.key}" onclick="focusElement('${m.key}')">
                    <span class="search-result-type">${formatType(m.type)}</span>
                    <span class="search-result-name">${m.name || m.key}</span>
                </div>
            `,
                    )
                    .join("");

                results.classList.add("open");
            }

            function updateSearchSelection(items, index) {
                items.forEach((item, i) => {
                    item.classList.toggle("selected", i === index);
                });
            }

            function formatType(type) {
                return type
                    .replace(/([A-Z])/g, " $1")
                    .trim()
                    .substring(0, 12);
            }

            function focusElement(key) {
                const results = document.getElementById("searchResults");
                const input = document.getElementById("searchInput");

                results.classList.remove("open");
                input.value = "";

                // Try to highlight in diagram
                try {
                    const elementRegistry = bpmnViewer.get("elementRegistry");
                    const canvas = bpmnViewer.get("canvas");

                    // Find element by our key
                    const el = lastParsedElements.get(key);
                    if (el && el.id) {
                        const shape = elementRegistry.get(el.id);
                        if (shape) {
                            // Center on element
                            const bbox = canvas.getGraphics(shape).getBBox();
                            canvas.zoom(1.5);
                            canvas.viewbox({
                                x: bbox.x - 200,
                                y: bbox.y - 150,
                                width: 500,
                                height: 400,
                            });

                            showToast(`Found: ${el.name || el.id}`);
                        }
                    }
                } catch (err) {
                    console.error("Focus error:", err);
                }

                // Also highlight in editor
                const editor = document.getElementById("codeEditor");
                const text = editor.value;
                const searchStr = key;
                const index = text.indexOf(searchStr);
                if (index >= 0) {
                    editor.focus();
                    editor.setSelectionRange(index, index + searchStr.length);
                }
            }

            // ============================================================
            // EXAMPLES
            // ============================================================
            function loadExample(name) {
                closeDropdowns();
                if (EXAMPLES[name]) {
                    document.getElementById("codeEditor").value =
                        EXAMPLES[name];
                    render();
                    autoSave();
                    showToast("Loaded: " + name);
                }
            }

            // ============================================================
            // UI HELPERS
            // ============================================================
            function toggleDropdown(id) {
                const menu = document.getElementById(id);
                const wasOpen = menu.classList.contains("open");
                closeDropdowns();
                if (!wasOpen) menu.classList.add("open");
            }

            function closeDropdowns() {
                document
                    .querySelectorAll(".dropdown-menu")
                    .forEach((m) => m.classList.remove("open"));
            }

            function copyCode() {
                navigator.clipboard.writeText(
                    document.getElementById("codeEditor").value,
                );
                showToast("Copied to clipboard");
            }

            function clearEditor() {
                document.getElementById("codeEditor").value = "";
                if (bpmnViewer) bpmnViewer.clear();
                lastBpmnXml = null;
                lastParsedElements = new Map();
                clearAutoSave();
                updateStatus("Cleared", false);
                document.getElementById("elementCount").textContent =
                    "0 elements";

                // Reset subprocess navigation
                navigationStack = [];
                currentRootElement = null;
                updateBreadcrumb();
            }

            function showToast(message) {
                const toast = document.getElementById("toast");
                toast.textContent = message;
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            }

            // ============================================================
            // RESIZER
            // ============================================================
            function initResizer() {
                const handle = document.getElementById("resizeHandle");
                const panel = document.getElementById("editorPanel");
                let startX, startWidth;

                handle.addEventListener("mousedown", (e) => {
                    startX = e.clientX;
                    startWidth = panel.offsetWidth;
                    document.addEventListener("mousemove", resize);
                    document.addEventListener("mouseup", stopResize);
                    document.body.style.cursor = "col-resize";
                    document.body.style.userSelect = "none";
                });

                function resize(e) {
                    const newWidth = startWidth + (e.clientX - startX);
                    if (newWidth > 350 && newWidth < window.innerWidth - 400) {
                        panel.style.width = newWidth + "px";
                    }
                }

                function stopResize() {
                    document.removeEventListener("mousemove", resize);
                    document.removeEventListener("mouseup", stopResize);
                    document.body.style.cursor = "";
                    document.body.style.userSelect = "";
                }
            }

            // ============================================================
            // UTILITIES
            // ============================================================
            function escapeXml(str) {
                if (!str) return "";
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&apos;");
            }

            function escapeHtml(str) {
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;");
            }
        </script>
    </body>
</html>
